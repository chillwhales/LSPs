---
phase: 04-testing-coverage-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - vitest.config.ts
  - package.json
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Running pnpm test --coverage produces per-package coverage reports in text, lcov, and HTML formats"
    - "If any package falls below 80% on any of four metrics (lines, branches, functions, statements), exit is non-zero"
    - "Running pnpm test:coverage produces the same result as pnpm test --coverage"
    - "Coverage output directory is gitignored"
    - "Single-package coverage works via pnpm test:coverage --filter=<package>"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Root-level coverage configuration with v8 provider and 80% thresholds"
      contains: "coverage"
    - path: "package.json"
      provides: "test:coverage script in root"
      contains: "test:coverage"
    - path: ".gitignore"
      provides: "coverage/ directory exclusion"
      contains: "coverage/"
  key_links:
    - from: "vitest.config.ts"
      to: "@vitest/coverage-v8"
      via: "provider: v8 config triggers automatic provider loading"
      pattern: "provider.*v8"
    - from: "package.json"
      to: "vitest.config.ts"
      via: "test:coverage script invokes vitest run --coverage"
      pattern: "vitest run --coverage"
---

<objective>
Configure coverage infrastructure and wire scripts for the monorepo

Purpose: Enable per-package coverage measurement with enforced 80% thresholds across all four metrics. This is the core deliverable of Phase 4 — coverage must work locally before CI can report it (Phase 5). Three report formats (text for terminal, lcov for CI/Codecov, HTML for local browsing) are generated simultaneously.

Output: `@vitest/coverage-v8` installed, root vitest.config.ts configured with coverage, scripts wired, .gitignore updated, baseline coverage captured as terminal output.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-testing-coverage-infrastructure/04-RESEARCH.md
@.planning/phases/04-testing-coverage-infrastructure/04-01-SUMMARY.md
@vitest.config.ts
@package.json
@.gitignore
@packages/config/src/vitest.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @vitest/coverage-v8 and configure coverage in root vitest.config.ts</name>
  <files>
    vitest.config.ts
  </files>
  <action>
**Step 1: Install the coverage provider at root only:**
```bash
pnpm add -D -w @vitest/coverage-v8
```
Do NOT install it in individual packages — root vitest handles everything.

**Step 2: Add coverage configuration to the root `vitest.config.ts`:**

Update the existing root `vitest.config.ts` to add a `coverage` block inside `test`. The current file is:
```typescript
import { defineConfig } from "vitest/config";
export default defineConfig({
  test: {
    projects: ["packages/*", "!packages/config"],
  },
});
```

Add the coverage config:
```typescript
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    projects: ["packages/*", "!packages/config"],
    coverage: {
      provider: "v8",
      reporter: ["text", "lcov", "html"],
      reportsDirectory: "./coverage",
      include: ["packages/*/src/**/*.ts"],
      exclude: [
        "**/*.test.ts",
        "**/*.d.ts",
        "**/index.ts",
      ],
      thresholds: {
        lines: 80,
        branches: 80,
        functions: 80,
        statements: 80,
      },
    },
  },
});
```

**Critical rules per research:**
- Do NOT set `coverage.enabled: true` — this would slow every `pnpm test` run. Coverage is enabled via the `--coverage` flag only.
- Do NOT add coverage config to `createVitestConfig()` in `packages/config/src/vitest.ts` — `defineProject()` does NOT support coverage options.
- Do NOT install `@vitest/coverage-v8` per-package — root handles everything.
- The `exclude` includes `**/index.ts` to skip barrel re-export files from coverage (they contain no logic, only re-exports, and would artificially lower branch coverage).
  </action>
  <verify>
Verify the config is syntactically valid:
```bash
pnpm test -- --project @chillwhales/lsp2
```
This should run tests without coverage (no --coverage flag) and still pass — confirming the config didn't break anything.

Then verify coverage works:
```bash
pnpm test --coverage -- --project @chillwhales/lsp2
```
This should produce a text coverage report in the terminal and create `coverage/` directory with lcov and HTML output.
  </verify>
  <done>Coverage config is in root vitest.config.ts with v8 provider, 3 reporters (text/lcov/html), 80% thresholds on all 4 metrics, and correct include/exclude patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Wire scripts, update .gitignore, and capture baseline coverage</name>
  <files>
    package.json
    .gitignore
  </files>
  <action>
**Step 1: Add `test:coverage` script to root `package.json`:**

Add to the `scripts` section:
```json
"test:coverage": "vitest run --coverage"
```

Place it after the existing `"test": "vitest run"` entry. This provides the dedicated script the user requested. The flag-based approach (`pnpm test --coverage`) also works because pnpm forwards unknown flags to vitest.

Per-package coverage is supported via pnpm workspace filter: `pnpm test:coverage --filter=@chillwhales/lsp2`. Do NOT add `test:coverage` to individual package.json files — the root script with `--filter` handles it.

**Step 2: Add `coverage/` to `.gitignore`:**

Add `coverage/` to the `.gitignore` file. Place it after the `dist/` entry for logical grouping (build artifacts together).

**Step 3: Run full coverage and capture baseline:**

Run full coverage across all packages:
```bash
pnpm test:coverage
```

This will:
- Show text coverage per-package in the terminal (baseline capture — not committed, just observed)
- Generate `coverage/lcov.info` for future Codecov integration
- Generate `coverage/index.html` for local browsing
- Exit non-zero if any package drops below 80% on any metric

**Important:** Per user decision, we capture baseline numbers as terminal output only — nothing is committed. If some packages fail the 80% threshold, that's expected and acceptable for this phase (the phase is infrastructure only — no new tests are written to meet coverage targets). The non-zero exit code is the CORRECT behavior — it proves thresholds are enforced.

Note the baseline results in the SUMMARY so they're available for future reference. Report which packages pass and which fail the 80% threshold.
  </action>
  <verify>
1. `pnpm test:coverage` produces coverage reports (text in terminal, files in coverage/)
2. `ls coverage/` shows lcov.info and HTML files
3. `pnpm test --coverage` produces the same result (flag forwarding works)
4. Verify `.gitignore` contains `coverage/` — run `git status` and confirm coverage/ doesn't show as untracked
5. Verify `pnpm test` (without --coverage) still works normally and does NOT produce coverage output
  </verify>
  <done>
- `test:coverage` script exists in root package.json
- `coverage/` is gitignored
- Coverage reports generate in text, lcov, and HTML formats simultaneously
- 80% thresholds enforced — exit non-zero if any package falls below
- Baseline coverage numbers captured as terminal output
- `pnpm test` (without --coverage) continues to work without coverage overhead
  </done>
</task>

</tasks>

<verification>
- `pnpm test` passes (no coverage overhead)
- `pnpm test:coverage` produces coverage reports in 3 formats
- `pnpm test --coverage` produces the same result as `pnpm test:coverage`
- `coverage/` directory is gitignored
- Threshold enforcement: if a package is below 80%, exit code is non-zero
- No coverage config in per-package vitest configs or createVitestConfig()
</verification>

<success_criteria>
- TEST-01 satisfied: Test coverage is measured via @vitest/coverage-v8
- TEST-02 satisfied: Minimum coverage thresholds are enforced at 80%
- Three report formats: text (terminal), lcov (CI), HTML (local browsing)
- Two ways to run: `pnpm test --coverage` and `pnpm test:coverage`
- Coverage output in `coverage/` at repo root, gitignored
- Baseline coverage numbers documented in plan summary
</success_criteria>

<output>
After completion, create `.planning/phases/04-testing-coverage-infrastructure/04-02-SUMMARY.md`
</output>
