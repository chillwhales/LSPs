---
phase: 04-testing-coverage-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/lsp29/src/guards.test.ts
  - packages/lsp29/src/decode.test.ts
  - packages/lsp29/src/schemas.test.ts
autonomous: true

must_haves:
  truths:
    - "All tests across the monorepo pass (zero failures)"
    - "lsp29 test fixtures match the Zod schema (images field present, createdAt removed)"
  artifacts:
    - path: "packages/lsp29/src/guards.test.ts"
      provides: "Fixed validAsset fixture and removed stale createdAt test"
      contains: "images: []"
    - path: "packages/lsp29/src/decode.test.ts"
      provides: "Fixed validAsset fixture"
      contains: "images: []"
    - path: "packages/lsp29/src/schemas.test.ts"
      provides: "Fixed inline fixture"
      contains: "images: []"
  key_links:
    - from: "packages/lsp29/src/guards.test.ts"
      to: "packages/lsp29/src/schemas.ts"
      via: "Zod schema validation (lsp29EncryptedAssetInnerSchema requires images)"
      pattern: "images"
---

<objective>
Fix the 10 pre-existing test failures in @chillwhales/lsp29

Purpose: Tests must pass before coverage infrastructure can produce meaningful results. The lsp29 Zod schema requires an `images` field (array of image arrays, per LSP4 format) but all test fixtures are missing it and include a stale `createdAt` field that doesn't exist in the schema. Per user decision: fix underlying bugs first, then fix test fixtures — but research confirmed the schema is correct (images IS required per LSP-29 spec), so these are fixture bugs only.

Output: All 3 test files fixed, `pnpm test` passes with zero failures.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-testing-coverage-infrastructure/04-RESEARCH.md
@packages/lsp29/src/schemas.ts
@packages/lsp29/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix lsp29 test fixtures and remove stale createdAt test</name>
  <files>
    packages/lsp29/src/guards.test.ts
    packages/lsp29/src/decode.test.ts
    packages/lsp29/src/schemas.test.ts
  </files>
  <action>
Fix all 3 test files in `packages/lsp29/src/` to match the current Zod schema (`lsp29EncryptedAssetInnerSchema` in `schemas.ts`). The schema requires `images: z.array(z.array(imageSchema))` and does NOT have a `createdAt` field.

**`guards.test.ts`:**
1. In the `validAsset` fixture (line ~13-45): Add `images: [],` field (empty array is valid — no images needed for tests). Remove `createdAt: "2024-01-01T00:00:00.000Z",` line.
2. In the "should return false for missing required fields" test (line ~84-97): The inline `missingTitle` fixture has `createdAt` — remove it. It does NOT need `images` added since it's intentionally incomplete.
3. DELETE the entire "should return false for invalid createdAt" test block (lines ~143-151) — this tests a field that doesn't exist in the schema.

**`decode.test.ts`:**
1. In the `validAsset` fixture (line ~13-45): Add `images: [],` field. Remove `createdAt: "2024-01-01T00:00:00.000Z",` line.

**`schemas.test.ts`:**
1. In the "should propagate refinement through full asset schema" test (line ~108-138): The inline `asset` fixture has `createdAt` — remove it. Add `images: [],` field to the inner `LSP29EncryptedAsset` object.

**Placement:** Add `images: [],` after the `revision` field (before `file`) to match the schema field order in `schemas.ts` (version → id → title → description → revision → images → file → encryption → chunks).

**Important:** Do NOT modify any other tests. Do NOT add images to intentionally-incomplete fixtures (like `missingTitle`). Only fix fixtures that are meant to be valid or fixtures that test a different concern (like method mismatch in schemas.test.ts).
  </action>
  <verify>
Run `pnpm test` from the repo root — all tests must pass with zero failures. Specifically verify the lsp29 package:
```bash
pnpm test -- --project @chillwhales/lsp29
```
Expected: All tests pass. The total test count will decrease by 1 (the removed createdAt test).
  </verify>
  <done>All lsp29 tests pass. Zero test failures across the entire monorepo. The removed test was for a field that doesn't exist in the schema.</done>
</task>

</tasks>

<verification>
- `pnpm test` exits with code 0
- No test file references `createdAt` in a valid fixture context
- All valid fixtures include `images: []`
</verification>

<success_criteria>
- Zero test failures across the monorepo
- lsp29 test fixtures match the Zod schema definition
- No regression in other packages' tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-testing-coverage-infrastructure/04-01-SUMMARY.md`
</output>
