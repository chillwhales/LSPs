---
phase: 05-ci-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .github/workflows/ci.yml
autonomous: true
requirements: [CI-01, CI-02, CI-03]

must_haves:
  truths:
    - "PRs trigger a CI workflow that runs install, typecheck, lint, build, and test"
    - "Pushing new commits to an open PR cancels the previous CI run"
    - "publint and attw validate package exports and types in CI before merge"
    - "Each hygiene tool (sherif, knip, madge) runs in its own isolated CI job"
    - "Tests run on both Node 22 and Node 24"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Complete 4-layer CI pipeline with 11 jobs"
      min_lines: 150
    - path: "package.json"
      provides: "typecheck script, publint+attw devDeps, engines >=22"
      contains: "typecheck"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json scripts"
      via: "pnpm run commands in workflow steps"
      pattern: "pnpm (build|test|check|sherif|knip|madge|biome)"
    - from: ".github/workflows/ci.yml (build job)"
      to: ".github/workflows/ci.yml (pkg-verify, test jobs)"
      via: "actions/upload-artifact → actions/download-artifact"
      pattern: "upload-artifact|download-artifact"
    - from: ".github/workflows/ci.yml (concurrency)"
      to: "GitHub PR/branch grouping"
      via: "concurrency group key"
      pattern: "cancel-in-progress: true"
---

<objective>
Create the GitHub Actions CI workflow with full 4-layer parallel pipeline, install package validation tools (publint, attw), and add missing root scripts.

Purpose: Every PR is automatically validated — typecheck, lint, format, build, hygiene checks, package validation, and tests — with in-progress runs cancelled on new pushes.

Output: `.github/workflows/ci.yml` with 11 jobs across 4 layers, updated `package.json` with new devDependencies and scripts.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ci-pipeline/05-CONTEXT.md
@.planning/phases/05-ci-pipeline/05-RESEARCH.md

<interfaces>
<!-- From root package.json — existing scripts the CI workflow will invoke -->
From package.json:
```json
{
  "scripts": {
    "build": "pnpm -r build",
    "test": "vitest run",
    "test:coverage": "vitest run --coverage",
    "check:lint": "biome check",
    "knip": "knip",
    "sherif": "sherif",
    "madge": "madge --circular --extensions ts --exclude '\\.test\\.ts$' --ts-config ./packages/config/tsconfig.base.json packages/*/src",
    "check": "pnpm check:lint && pnpm sherif && pnpm knip && pnpm madge"
  },
  "packageManager": "pnpm@10.30.2",
  "engines": { "node": ">=18" }
}
```

From vitest.config.ts — coverage already configured:
```typescript
coverage: {
  provider: "v8",
  reporter: ["text", "lcov", "html"],
  reportsDirectory: "./coverage",
  thresholds: { lines: 80, branches: 80, functions: 80, statements: 80 }
}
```

From pnpm-workspace.yaml:
```yaml
packages:
  - packages/*
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install publint/attw, add typecheck script, update engines</name>
  <files>package.json</files>
  <action>
    1. Install publint and @arethetypeswrong/cli as root devDependencies:
       ```
       pnpm add -Dw publint @arethetypeswrong/cli
       ```

    2. Add a `typecheck` script to root package.json:
       ```json
       "typecheck": "pnpm -r --filter '!@chillwhales/config' exec tsc --noEmit"
       ```
       The config package has no src code to typecheck — it only exports raw .ts files. Filtering it out avoids tsc errors about missing rootDir.

    3. Update the `engines` field from `">=18"` to `">=22"` per user decision (reflects what's actually tested in CI).

    4. Verify the new scripts work locally:
       - Run `pnpm typecheck` — should pass with no errors
       - Run `pnpm -r --filter '!@chillwhales/config' exec publint --strict` — this may warn about missing fields (that's OK, Phase 6 fixes metadata). Just confirm it runs without crashing.
       - Run `pnpm -r --filter '!@chillwhales/config' exec attw --pack .` — confirm it runs. Build first if needed: `pnpm build` then run attw.

    Note: publint and attw may report warnings about missing README, LICENSE, or incomplete package.json fields. That's expected — Phase 6 addresses package metadata. The important thing is they execute successfully and the CI job won't crash.
  </action>
  <verify>
    <automated>pnpm typecheck && pnpm build && pnpm -r --filter '!@chillwhales/config' exec publint --strict && pnpm -r --filter '!@chillwhales/config' exec attw --pack .</automated>
  </verify>
  <done>
    - `publint` and `@arethetypeswrong/cli` in root devDependencies
    - `typecheck` script runs `pnpm -r --filter '!@chillwhales/config' exec tsc --noEmit` successfully
    - `engines.node` is `">=22"`
    - All three commands (typecheck, publint, attw) execute without crashing
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
    Create `.github/workflows/ci.yml` implementing the user's 4-layer parallel pipeline design. The complete structure:

    **Top-level config:**
    - `name: CI`
    - Triggers: `push` to `main` + `pull_request` to `main`
    - Concurrency: group by `${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}`, `cancel-in-progress: true` (CI-02)

    **Layer 1 — Install (1 job):**
    - `install` job: checkout → pnpm/action-setup@v4 → actions/setup-node@v4 (node 24, cache: 'pnpm') → `pnpm install --frozen-lockfile`
    - Purpose: warm the pnpm store cache for downstream jobs

    **Layer 2 — Validate + Build (6 parallel jobs, all `needs: [install]`):**
    Each job follows the same preamble pattern: checkout → pnpm/action-setup@v4 → actions/setup-node@v4 (node 24, cache: 'pnpm') → pnpm install --frozen-lockfile → run command.

    Action order in each step is CRITICAL (per research Pitfall 1): (1) checkout, (2) pnpm/action-setup, (3) setup-node with cache: 'pnpm'. If setup-node runs before pnpm is installed, cache detection fails.

    Jobs:
    1. `typecheck` — runs `pnpm typecheck` (the script added in Task 1)
    2. `lint` — runs `pnpm biome ci` (CI-specific mode, equivalent to `biome check` but clearer in CI context)
    3. `sherif` — runs `pnpm sherif`
    4. `knip` — runs `pnpm knip`
    5. `madge` — runs `pnpm madge`
    6. `build` — runs `pnpm build`, then uploads artifacts:
       ```yaml
       - uses: actions/upload-artifact@v4
         with:
           name: build-output
           path: packages/*/dist
           retention-days: 1
       ```

    **Layer 3 — Verify + Test (3 parallel jobs, all `needs: [build]`):**

    7. `pkg-verify` — Package Verification (CI-03):
       - Same preamble (node 24)
       - Download build artifact: `actions/download-artifact@v4` with `name: build-output` and `path: .` (restore at repo root so packages/*/dist aligns correctly — per research Pitfall 2)
       - Run: `pnpm -r --filter '!@chillwhales/config' exec publint --strict`
       - Run: `pnpm -r --filter '!@chillwhales/config' exec attw --pack .`

    8-9. `test` — Test matrix job (Node 22 + Node 24):
       ```yaml
       strategy:
         matrix:
           node-version: [22, 24]
       ```
       - Preamble uses `${{ matrix.node-version }}` for setup-node
       - Download build artifact (same as pkg-verify — safe approach per research Open Question 4, in case some packages' tests depend on built output from other workspace packages)
       - Run: `pnpm test:coverage`
       - After test:coverage, upload coverage artifact (Node 24 only) for Layer 4:
         ```yaml
         - uses: actions/upload-artifact@v4
           if: matrix.node-version == 24
           with:
             name: coverage-report
             path: coverage/lcov.info
             retention-days: 1
         ```

    **Layer 4 — Report (1 job, `needs: [test]`):**

    10. `codecov` — Coverage Report (CI-04):
        - `if: always() && needs.test.result == 'success'`
        - Checkout (needed for codecov-action to map coverage to source)
        - Download coverage artifact
        - `codecov/codecov-action@v5` with:
          - `files: ./coverage/lcov.info`
          - `token: ${{ secrets.CODECOV_TOKEN }}`
          - `fail_ci_if_error: true`

    **Important implementation notes:**
    - Use descriptive `name:` for each job for GitHub UI readability
    - Do NOT use `biome check` in CI — use `biome ci` (the non-interactive CI alias that's clearer in log output)
    - The `runs-on: ubuntu-latest` for all jobs
    - For the download-artifact `path` in pkg-verify and test jobs: use `path: .` to restore at repo root. This ensures `packages/*/dist` ends up in the correct location. (Research Pitfall 2)
  </action>
  <verify>
    <automated>test -f .github/workflows/ci.yml && grep -q "cancel-in-progress: true" .github/workflows/ci.yml && grep -q "publint" .github/workflows/ci.yml && grep -q "codecov" .github/workflows/ci.yml && grep -q "node-version: \[22, 24\]" .github/workflows/ci.yml</automated>
  </verify>
  <done>
    - `.github/workflows/ci.yml` exists with 11 jobs across 4 layers
    - Workflow triggers on PR and push to main
    - Concurrency cancels in-progress runs (CI-02)
    - Layer 2 has 6 parallel jobs: typecheck, lint, sherif, knip, madge, build
    - Layer 3 has 3 parallel jobs: pkg-verify (publint+attw), test Node 22, test Node 24
    - Layer 4 uploads coverage to Codecov from Node 24 only
    - Build artifacts are passed from build → pkg-verify and test jobs
    - Coverage artifact is passed from test (Node 24) → codecov job
  </done>
</task>

</tasks>

<verification>
1. `cat .github/workflows/ci.yml` — workflow file exists with correct structure
2. `grep -c "needs:" .github/workflows/ci.yml` — should show dependency chains between jobs
3. `grep "cancel-in-progress" .github/workflows/ci.yml` — concurrency cancellation present
4. `grep "node-version:" .github/workflows/ci.yml` — Node 24 for most jobs, matrix [22, 24] for test
5. `pnpm typecheck` — new script works
6. `jq '.engines.node' package.json` — shows ">=22"
7. `jq '.devDependencies | keys[]' package.json | grep -E "publint|arethetypeswrong"` — both installed
</verification>

<success_criteria>
- CI workflow file has 11 jobs in 4 layers with correct dependency chains
- All checks are blocking (no advisory-only)
- publint+attw run against built output in Layer 3
- Tests run on Node 22 and Node 24 with coverage
- Concurrency cancels in-progress runs
- typecheck, publint, attw commands all work locally
- engines field updated to >=22
</success_criteria>

<output>
After completion, create `.planning/phases/05-ci-pipeline/05-01-SUMMARY.md`
</output>
