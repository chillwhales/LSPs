---
phase: 05-ci-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - codecov.yml
autonomous: true
requirements: [CI-04]

must_haves:
  truths:
    - "Codecov reports coverage on every PR with status check and PR comment"
    - "Patch coverage threshold of 80% is enforced — new/changed lines must be tested"
    - "Coverage from packages/config is excluded (no testable code)"
    - "All CI-targeted scripts execute successfully locally"
  artifacts:
    - path: "codecov.yml"
      provides: "Codecov configuration with patch coverage, PR comments, ignore patterns"
      min_lines: 10
      contains: "patch"
  key_links:
    - from: ".github/workflows/ci.yml (codecov job)"
      to: "codecov.yml"
      via: "Codecov action reads config from repo root automatically"
      pattern: "codecov/codecov-action"
    - from: "codecov.yml (patch target)"
      to: "coverage/lcov.info"
      via: "Codecov analyzes lcov data against patch diff"
      pattern: "target: 80%"
---

<objective>
Create Codecov configuration and validate the entire CI pipeline works locally.

Purpose: Coverage reporting is configured with version-controlled settings (not web UI), patch coverage is enforced at 80%, and all CI commands are verified to work before the first real CI run.

Output: `codecov.yml` at repo root, all CI-targeted commands verified locally.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ci-pipeline/05-CONTEXT.md
@.planning/phases/05-ci-pipeline/05-RESEARCH.md
@.planning/phases/05-ci-pipeline/05-01-SUMMARY.md

<interfaces>
<!-- From 05-01: CI workflow depends on codecov.yml being present -->
From .github/workflows/ci.yml (created in 05-01):
```yaml
# Codecov job uses codecov/codecov-action@v5
# It automatically reads codecov.yml from repo root for configuration
# Files uploaded: coverage/lcov.info
```

From vitest.config.ts — lcov reporter already configured:
```typescript
coverage: {
  reporter: ["text", "lcov", "html"],
  reportsDirectory: "./coverage",
  thresholds: { lines: 80, branches: 80, functions: 80, statements: 80 }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create codecov.yml configuration</name>
  <files>codecov.yml</files>
  <action>
    Create `codecov.yml` at the repo root (not inside `.github/`). This is the version-controlled Codecov configuration per user decision.

    Configuration:

    ```yaml
    # Codecov configuration
    # Docs: https://docs.codecov.com/docs/codecov-yaml

    coverage:
      status:
        project:
          default:
            target: auto       # compare against base commit's coverage
            threshold: 2%      # allow up to 2% project coverage drop (refactoring, deleting well-covered code)
        patch:
          default:
            target: 80%        # new/changed lines must have 80% coverage (per user decision)

    comment:
      layout: "condensed_header, diff, flags, files"
      behavior: default
      require_changes: true    # only comment on PR if coverage actually changed

    ignore:
      - "packages/config/**"   # no testable code — only defineProject/defineBuildConfig wrappers
    ```

    **Key decisions:**
    - `project.target: auto` with `threshold: 2%` — allows minor coverage dips from refactoring without failing. The user locked "coverage threshold violations block merge" but that's enforced via Vitest's local thresholds (80% lines/branches/functions/statements). Codecov's project check is a guard against significant regressions, not an exact threshold.
    - `patch.target: 80%` — per user decision, new/changed lines must be 80% covered.
    - `require_changes: true` on comment — avoids noisy PR comments when coverage didn't change.
    - `packages/config/**` ignored — consistent with vitest.config.ts exclusion, no testable logic.
  </action>
  <verify>
    <automated>test -f codecov.yml && grep -q "target: 80%" codecov.yml && grep -q "packages/config" codecov.yml</automated>
  </verify>
  <done>
    - `codecov.yml` exists at repo root
    - Patch coverage target set to 80%
    - Project coverage uses auto target with 2% threshold
    - PR comment configured with condensed layout
    - packages/config excluded from coverage analysis
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end local validation of all CI commands</name>
  <files></files>
  <action>
    Run every command that the CI workflow will execute, in the same order, to verify nothing will fail on the first real CI run. This is a pure validation task — no files are created or modified.

    **Layer 2 commands (all should pass):**
    1. `pnpm typecheck` — tsc --noEmit for all packages except config
    2. `pnpm biome ci` — lint + format check (non-interactive CI mode)
    3. `pnpm sherif` — monorepo consistency
    4. `pnpm knip` — unused deps/exports
    5. `pnpm madge` — circular dependencies
    6. `pnpm build` — build all packages

    **Layer 3 commands (after build):**
    7. `pnpm -r --filter '!@chillwhales/config' exec publint --strict` — package validation
    8. `pnpm -r --filter '!@chillwhales/config' exec attw --pack .` — type validation
    9. `pnpm test:coverage` — tests with coverage (produces coverage/lcov.info)

    **Verify coverage output exists:**
    10. `ls coverage/lcov.info` — must exist after test:coverage

    If any command fails:
    - For publint/attw warnings about missing README, LICENSE, or incomplete metadata: these are EXPECTED and will be fixed in Phase 6. If publint `--strict` fails due to these, consider whether the CI workflow should use `publint` (without --strict) for now, or add a note in the plan summary that Phase 6 will resolve these warnings. Make a judgment call — if the warnings are about missing dist files or broken exports, that's a real problem. If they're about missing metadata fields, that's Phase 6 territory.
    - For any other failures: diagnose and fix. The CI workflow must not fail on its first run for reasons we could have caught locally.

    If attw reports issues with ESM/CJS type resolution, investigate whether these are real problems or false positives. Document findings in the plan summary.
  </action>
  <verify>
    <automated>pnpm typecheck && pnpm biome ci && pnpm sherif && pnpm knip && pnpm madge && pnpm build && pnpm -r --filter '!@chillwhales/config' exec publint --strict && pnpm -r --filter '!@chillwhales/config' exec attw --pack . && pnpm test:coverage && test -f coverage/lcov.info</automated>
  </verify>
  <done>
    - All 9 CI commands execute successfully (or known-acceptable warnings documented)
    - `coverage/lcov.info` is produced by test:coverage
    - Any publint/attw warnings are categorized as "Phase 6 metadata" or "real problem requiring fix"
    - Confidence that the CI workflow will pass on first real run
  </done>
</task>

</tasks>

<verification>
1. `cat codecov.yml` — configuration file exists with correct settings
2. `grep "target: 80%" codecov.yml` — patch coverage threshold present
3. `grep "packages/config" codecov.yml` — config package excluded
4. Run full CI command chain locally (see Task 2 verify) — all pass
5. `ls coverage/lcov.info` — coverage output exists in lcov format for Codecov
</verification>

<success_criteria>
- codecov.yml exists at repo root with patch coverage at 80%, project coverage with 2% threshold
- packages/config is excluded from Codecov analysis
- PR comment is configured (condensed_header, diff, flags, files)
- All CI commands pass locally (typecheck, biome ci, sherif, knip, madge, build, publint, attw, test:coverage)
- coverage/lcov.info is produced and ready for Codecov upload
</success_criteria>

<output>
After completion, create `.planning/phases/05-ci-pipeline/05-02-SUMMARY.md`
</output>
