---
phase: 06-package-metadata-publish-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - LICENSE
  - .gitignore
  - packages/config/src/build.ts
  - packages/utils/package.json
  - packages/lsp2/package.json
  - packages/lsp3/package.json
  - packages/lsp4/package.json
  - packages/lsp6/package.json
  - packages/lsp23/package.json
  - packages/lsp29/package.json
  - packages/lsp30/package.json
autonomous: true
requirements: [PKG-01, PKG-03, PKG-04]

must_haves:
  truths:
    - "publint --strict passes for all 8 publishable packages"
    - "attw --pack passes for all 8 publishable packages (no FalseCJS)"
    - "Build output is ESM-only — no .cjs files in any package dist/"
    - "Each package.json has type, engines, repository, keywords, sideEffects fields"
    - "LICENSE file exists at repo root and can be copied into each package at pack time"
    - "Viem peer deps declared on lsp2, lsp6, lsp23, lsp29, lsp30 (resolves to ^2.0.0)"
  artifacts:
    - path: "LICENSE"
      provides: "MIT license text"
      contains: "MIT License"
    - path: "packages/config/src/build.ts"
      provides: "Shared build config (ESM-only)"
      exports: ["createBuildConfig"]
    - path: "packages/lsp2/package.json"
      provides: "Complete package metadata"
      contains: "type"
  key_links:
    - from: "packages/config/src/build.ts"
      to: "packages/*/dist/"
      via: "rollup emitCJS removal"
      pattern: "no.*emitCJS"
    - from: "packages/*/package.json"
      to: "publint --strict"
      via: "type: module + ESM-only exports"
      pattern: "\"type\":\\s*\"module\""
    - from: "packages/*/package.json prepack script"
      to: "LICENSE in tarball"
      via: "cp ../../LICENSE ."
      pattern: "prepack.*cp.*LICENSE"
---

<objective>
Add complete package metadata, switch to ESM-only builds, create LICENSE, and resolve publint/attw FalseCJS failures across all 8 publishable packages.

Purpose: Fix the FalseCJS type declaration issue blocking CI strict checks, add all npm-required metadata fields, and set up LICENSE distribution — making packages ready for first publish.
Output: All packages pass `publint --strict` and `attw --pack`, complete metadata in all package.json files, LICENSE at repo root with prepack copy mechanism.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-package-metadata-publish-readiness/06-CONTEXT.md
@.planning/phases/05-ci-pipeline/05-02-SUMMARY.md

<interfaces>
<!-- Current build config that needs ESM-only change -->
From packages/config/src/build.ts:
```typescript
import type { BuildConfig } from "unbuild";
import { defineBuildConfig } from "unbuild";

type BuildConfigOverrides = Partial<Omit<BuildConfig, "preset" | "hooks">>;

export function createBuildConfig(overrides: BuildConfigOverrides = {}): BuildConfig[] {
	return defineBuildConfig({
		entries: ["src/index"],
		declaration: "compatible",
		clean: true,
		failOnWarn: true,
		rollup: {
			emitCJS: true,  // REMOVE THIS — ESM-only per user decision
		},
		...overrides,
	});
}
```

<!-- Current package.json pattern (lsp2 as example — all 8 follow same structure) -->
From packages/lsp2/package.json (representative):
```json
{
  "name": "@chillwhales/lsp2",
  "version": "0.1.0",
  "description": "...",
  "author": "b00ste",
  "license": "MIT",
  "main": "./dist/index.mjs",
  "module": "./dist/index.mjs",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.mjs",
      "require": "./dist/index.cjs"
    }
  },
  "files": ["dist", "package.json"]
}
```

<!-- Current dist output (all variants generated by unbuild declaration: "compatible") -->
dist/: index.cjs, index.d.cts, index.d.mts, index.d.ts, index.mjs

<!-- Git remote (for repository field) -->
origin: https://github.com/chillwhales/LSPs.git

<!-- pnpm catalog (for viem peer dep resolution) -->
From pnpm-workspace.yaml: viem: ^2.0.0
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LICENSE, switch to ESM-only, update all package.json metadata</name>
  <files>
    LICENSE
    .gitignore
    packages/config/src/build.ts
    packages/utils/package.json
    packages/lsp2/package.json
    packages/lsp3/package.json
    packages/lsp4/package.json
    packages/lsp6/package.json
    packages/lsp23/package.json
    packages/lsp29/package.json
    packages/lsp30/package.json
  </files>
  <action>
**1. Create `LICENSE` at repo root:**

MIT License, copyright "2026 Chillwhales contributors". Standard MIT text from https://opensource.org/licenses/MIT.

**2. Add `packages/*/LICENSE` to `.gitignore`:**

Append a line `packages/*/LICENSE` to the existing `.gitignore`. These files are generated at prepack time, not committed.

**3. Update `packages/config/src/build.ts` — ESM-only:**

Remove the entire `rollup: { emitCJS: true }` block. The function becomes:

```typescript
export function createBuildConfig(overrides: BuildConfigOverrides = {}): BuildConfig[] {
	return defineBuildConfig({
		entries: ["src/index"],
		declaration: "compatible",
		clean: true,
		failOnWarn: true,
		...overrides,
	});
}
```

This stops generating `.cjs` and `.d.cts` files. Per user decision: "ESM-only — no CJS build output, no dual-package hazard."

**4. Update all 8 publishable package.json files** (utils, lsp2, lsp3, lsp4, lsp6, lsp23, lsp29, lsp30):

For EVERY package, apply these changes:

a) **Add `"type": "module"`** — marks package as ESM

b) **Remove `"module"` field** — redundant with `type: module` + exports map

c) **Update `"types"`** from `"./dist/index.d.ts"` to `"./dist/index.d.mts"` — explicit ESM types

d) **Update `"exports"` to ESM-only** — remove `require` condition:
```json
"exports": {
  ".": {
    "types": "./dist/index.d.mts",
    "default": "./dist/index.mjs"
  }
}
```

e) **Add `"engines"`:**
```json
"engines": { "node": ">=22" }
```

f) **Add `"repository"`** (adjust `directory` per package):
```json
"repository": {
  "type": "git",
  "url": "git+https://github.com/chillwhales/LSPs.git",
  "directory": "packages/<name>"
}
```

g) **Add `"keywords"`** following this strategy:
- **All packages** get base: `["chillwhales", "lukso", "lsp"]` plus package-specific:
- **utils**: add `"utility"`, `"helpers"`
- **lsp2**: add `"lsp2"`, `"erc725y"`, `"verifiable-uri"`, `"json-schema"`
- **lsp3**: add `"lsp3"`, `"universal-profile"`, `"profile-metadata"`
- **lsp4**: add `"lsp4"`, `"digital-asset"`, `"metadata"`, `"lsp7"`, `"lsp8"`
- **lsp6**: add `"lsp6"`, `"key-manager"`, `"permissions"`
- **lsp23**: add `"lsp23"`, `"linked-contracts"`, `"universal-profile"`, `"deployment"`
- **lsp29**: add `"lsp29"`, `"encrypted-assets"`, `"encryption"`
- **lsp30**: add `"lsp30"`, `"multi-storage"`, `"storage-uri"`

h) **Add `"sideEffects": false`** — enables tree-shaking for bundlers

i) **Update `"files"`** to `["dist", "LICENSE", "README.md"]`

j) **Add scripts for LICENSE distribution:**
```json
"prepack": "cp ../../LICENSE .",
"postpack": "rm -f LICENSE"
```

**5. Verify viem peer dependencies are correct:**
- lsp2, lsp6, lsp23, lsp29, lsp30: MUST have `"peerDependencies": { "viem": "catalog:" }` (resolves to `^2.0.0` at publish). These already exist — leave them.
- lsp3, lsp4, utils: MUST NOT have viem peer dep (they don't import viem directly). These already don't have it — leave them.

**6. Update utils description** from "Utility functions" to "Shared utility functions for the @chillwhales LUKSO Standards Packages"
  </action>
  <verify>
    <automated>export PATH="/home/coder/.nvm/nvm/versions/node/v20.20.0/bin:$PATH" && cd /home/coder/LSPs && pnpm build 2>&1 | tail -5 && ls packages/lsp2/dist/ | sort && cat LICENSE | head -3 && node -e "const p = require('./packages/lsp2/package.json'); console.log('type:', p.type, 'engines:', JSON.stringify(p.engines), 'repo:', !!p.repository, 'keywords:', p.keywords?.length > 0)"</automated>
  </verify>
  <done>
    - LICENSE exists at repo root with MIT text, 2026, Chillwhales contributors
    - packages/*/LICENSE in .gitignore
    - Build output is ESM-only (no .cjs in dist/)
    - All 8 package.json files have: type, engines, repository, keywords, sideEffects, updated exports, prepack/postpack scripts
    - Viem peer deps unchanged and correct on 5 packages
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify publint and attw pass on all packages</name>
  <files></files>
  <action>
**1. Rebuild all packages** to confirm ESM-only output:
```bash
pnpm build
```
Verify: Each package's `dist/` contains ONLY `index.mjs`, `index.d.ts`, `index.d.mts` — NO `index.cjs`, NO `index.d.cts`.

**2. Run publint --strict on all publishable packages:**
```bash
pnpm -r --filter './packages/*' --filter '!@chillwhales/config' exec npx publint --strict
```
Expected: All 8 packages pass. The FalseCJS issue is resolved because:
- `"type": "module"` declares ESM
- No CJS output exists
- Exports map only has ESM conditions

**3. Run attw --pack on all publishable packages:**
```bash
pnpm -r --filter './packages/*' --filter '!@chillwhales/config' exec npx attw --pack .
```
Expected: All 8 packages pass. No "Masquerading as CJS" errors.

**4. Verify LICENSE would appear in tarball:**
Copy LICENSE to one package temporarily, run npm pack --dry-run, confirm LICENSE is listed:
```bash
cp LICENSE packages/lsp2/ && cd packages/lsp2 && npm pack --dry-run 2>&1 | grep LICENSE && rm -f LICENSE
```

**5. If any publint or attw check fails:**
- Read the error message carefully
- Fix the specific package.json field or exports condition
- Rebuild and re-check
  </action>
  <verify>
    <automated>export PATH="/home/coder/.nvm/nvm/versions/node/v20.20.0/bin:$PATH" && cd /home/coder/LSPs && pnpm -r --filter './packages/*' --filter '!@chillwhales/config' exec npx publint --strict 2>&1 | tail -20</automated>
  </verify>
  <done>
    - publint --strict exits 0 for all 8 packages (was failing with FalseCJS before)
    - attw --pack exits 0 for all 8 packages (was failing with "Masquerading as CJS" before)
    - LICENSE confirmed present in tarball via npm pack --dry-run
  </done>
</task>

</tasks>

<verification>
- All 8 publishable packages pass `publint --strict` (zero warnings, zero errors)
- All 8 publishable packages pass `attw --pack .` (no FalseCJS, no type issues)
- `pnpm build` succeeds with zero warnings
- Build output is ESM-only: each `dist/` has `.mjs` + `.d.ts` + `.d.mts`, NO `.cjs` or `.d.cts`
- LICENSE file exists at repo root
- `packages/*/LICENSE` is gitignored
- Each package.json includes: `type`, `engines`, `repository`, `keywords`, `sideEffects`, `files`, `prepack`, `postpack`
- Viem peer deps exist on lsp2, lsp6, lsp23, lsp29, lsp30 — absent on lsp3, lsp4, utils
</verification>

<success_criteria>
- publint --strict and attw --pack pass on all 8 publishable packages (was failing on all 8 before this plan)
- All package.json files have complete metadata fields
- ESM-only build output (no CJS files generated)
- LICENSE infrastructure ready for first publish
</success_criteria>

<output>
After completion, create `.planning/phases/06-package-metadata-publish-readiness/06-01-SUMMARY.md`
</output>
