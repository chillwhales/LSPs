---
phase: 01-build-hardening-shared-configs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/config/package.json
  - packages/config/src/build.ts
  - packages/config/src/vitest.ts
  - packages/config/tsconfig.base.json
  - pnpm-workspace.yaml
  - packages/utils/package.json
  - packages/lsp2/package.json
  - packages/lsp3/package.json
  - packages/lsp4/package.json
  - packages/lsp6/package.json
  - packages/lsp23/package.json
  - packages/lsp29/package.json
  - packages/lsp30/package.json
autonomous: true

must_haves:
  truths:
    - "@chillwhales/config package exists as a private workspace package"
    - "Shared dependency versions are declared once in pnpm-workspace.yaml catalog"
    - "All 8 packages reference catalog: for shared deps and depend on @chillwhales/config"
    - "pnpm install succeeds with zero resolution errors"
  artifacts:
    - path: "packages/config/package.json"
      provides: "Private config package with subpath exports for build, vitest, tsconfig"
      contains: "@chillwhales/config"
    - path: "packages/config/src/build.ts"
      provides: "createBuildConfig factory function"
      exports: ["createBuildConfig"]
    - path: "packages/config/src/vitest.ts"
      provides: "createVitestConfig factory function"
      exports: ["createVitestConfig"]
    - path: "packages/config/tsconfig.base.json"
      provides: "Shared TypeScript base configuration"
      contains: "compilerOptions"
    - path: "pnpm-workspace.yaml"
      provides: "Catalog with centralized dependency versions"
      contains: "catalog:"
  key_links:
    - from: "packages/*/package.json"
      to: "pnpm-workspace.yaml"
      via: "catalog: protocol references"
      pattern: "\"catalog:\""
    - from: "packages/*/package.json"
      to: "packages/config/package.json"
      via: "workspace:* devDependency"
      pattern: "@chillwhales/config.*workspace:"
---

<objective>
Create the @chillwhales/config workspace package with shared build, vitest, and tsconfig presets, add pnpm catalogs for centralized dependency versioning, and migrate all 8 package.json files to use catalog: references and depend on the config package.

Purpose: Establishes the foundation that all subsequent plans depend on — shared config source and centralized versions.
Output: Config package with factory functions, pnpm catalog, and all package.json files migrated.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-hardening-shared-configs/01-CONTEXT.md
@.planning/phases/01-build-hardening-shared-configs/01-RESEARCH.md
@pnpm-workspace.yaml
@package.json
@tsconfig.base.json
@packages/utils/package.json
@packages/lsp2/package.json
@packages/lsp6/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create @chillwhales/config workspace package</name>
  <files>
    packages/config/package.json
    packages/config/src/build.ts
    packages/config/src/vitest.ts
    packages/config/tsconfig.base.json
  </files>
  <action>
Create the `packages/config` directory and all files:

**packages/config/package.json:**
```json
{
  "name": "@chillwhales/config",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "exports": {
    "./build": "./src/build.ts",
    "./vitest": "./src/vitest.ts",
    "./tsconfig": "./tsconfig.base.json"
  },
  "devDependencies": {
    "unbuild": "catalog:",
    "vitest": "catalog:",
    "typescript": "catalog:"
  }
}
```

Note: No build step needed for this package. Both unbuild (via jiti) and vitest (via Vite) consume .ts files natively. The subpath exports point directly to source .ts files. The `./tsconfig` export is included per user decision for consistency, though tsconfig `extends` resolves via filesystem (not Node.js exports) — the actual resolution uses the pnpm workspace symlink.

**packages/config/src/build.ts:**
```typescript
import { defineBuildConfig } from "unbuild";
import type { BuildConfig } from "unbuild";

type BuildConfigOverrides = Partial<Omit<BuildConfig, "preset" | "hooks">>;

export function createBuildConfig(overrides: BuildConfigOverrides = {}): BuildConfig[] {
  return defineBuildConfig({
    entries: ["src/index"],
    declaration: "compatible",
    clean: true,
    failOnWarn: true,
    rollup: {
      emitCJS: true,
    },
    ...overrides,
  });
}
```

Note: `failOnWarn: true` is set here (unbuild defaults to true, but being explicit is clearer). Current packages all have `failOnWarn: false` — Plan 02 will handle the transition by fixing warnings first.

**packages/config/src/vitest.ts:**
```typescript
import { defineProject } from "vitest/config";

interface VitestConfigOverrides {
  globals?: boolean;
  environment?: string;
  [key: string]: unknown;
}

export function createVitestConfig(overrides: VitestConfigOverrides = {}) {
  return defineProject({
    test: {
      globals: true,
      environment: "node",
      ...overrides,
    },
  });
}
```

Minimal preset per user's locked decision: `globals: true`, `environment: "node"` — no speculative additions.

**packages/config/tsconfig.base.json:**
Copy the exact contents of the root `tsconfig.base.json`:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "lib": ["ES2022"],
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "exclude": ["node_modules", "dist"]
}
```

tsconfig extends resolves via filesystem (not Node.js exports), so the file must be at the package root, not in src/.
  </action>
  <verify>
Verify files exist and have correct content:
- `ls packages/config/package.json packages/config/src/build.ts packages/config/src/vitest.ts packages/config/tsconfig.base.json`
- Check package.json has `"private": true` and correct exports
- Check build.ts exports `createBuildConfig`
- Check vitest.ts exports `createVitestConfig`
  </verify>
  <done>
packages/config directory exists with package.json (private, subpath exports for ./build and ./vitest), src/build.ts (createBuildConfig factory with failOnWarn: true), src/vitest.ts (createVitestConfig factory with globals: true, environment: node), and tsconfig.base.json (copy of root base config).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pnpm catalogs and migrate all package.json files</name>
  <files>
    pnpm-workspace.yaml
    packages/utils/package.json
    packages/lsp2/package.json
    packages/lsp3/package.json
    packages/lsp4/package.json
    packages/lsp6/package.json
    packages/lsp23/package.json
    packages/lsp29/package.json
    packages/lsp30/package.json
  </files>
  <action>
**Step 1: Add catalog to pnpm-workspace.yaml:**

Update `pnpm-workspace.yaml` to:
```yaml
packages:
  - packages/*

catalog:
  typescript: ^5.9.3
  unbuild: ^3.6.1
  vitest: ^4.0.17
  zod: ^3.24.1
  viem: ^2.0.0
  "@erc725/erc725.js": ^0.28.2
  "@lukso/lsp6-contracts": ^0.15.5
  "@lukso/universalprofile-contracts": ^0.15.5
```

Single default catalog per user's locked decision. Threshold: any dep shared by 2+ packages. All the above meet this threshold based on the dependency table.

**Step 2: Migrate each package.json to catalog: references:**

For every dependency version that exists in the catalog, replace the version string with `"catalog:"`. Also add `"@chillwhales/config": "workspace:*"` to devDependencies of each package.

The exact changes per package:

**packages/utils/package.json** — devDependencies only:
- `"typescript": "^5.9.3"` → `"typescript": "catalog:"`
- `"unbuild": "^3.6.1"` → `"unbuild": "catalog:"`
- `"vitest": "^4.0.17"` → `"vitest": "catalog:"`
- Add: `"@chillwhales/config": "workspace:*"`

**packages/lsp2/package.json**:
- dependencies: `"zod": "^3.24.1"` → `"zod": "catalog:"`
- peerDependencies: `"viem": "^2.0.0"` → `"viem": "catalog:"`
- devDependencies: `"typescript"` → `"catalog:"`, `"unbuild"` → `"catalog:"`, `"vitest"` → `"catalog:"`, `"viem": "^2.0.0"` → `"viem": "catalog:"`
- Add: `"@chillwhales/config": "workspace:*"` to devDependencies

**packages/lsp3/package.json**:
- dependencies: `"zod"` → `"catalog:"`
- devDependencies: `"typescript"` → `"catalog:"`, `"unbuild"` → `"catalog:"`, `"vitest"` → `"catalog:"`
- Add: `"@chillwhales/config": "workspace:*"` to devDependencies

**packages/lsp4/package.json**:
- dependencies: `"zod"` → `"catalog:"`
- devDependencies: `"typescript"` → `"catalog:"`, `"unbuild"` → `"catalog:"`, `"vitest"` → `"catalog:"`
- Add: `"@chillwhales/config": "workspace:*"` to devDependencies

**packages/lsp6/package.json**:
- dependencies: `"@erc725/erc725.js": "^0.28.2"` → `"catalog:"`, `"@lukso/lsp6-contracts": "^0.15.5"` → `"catalog:"`, `"zod"` → `"catalog:"`
- peerDependencies: `"viem"` → `"catalog:"`
- devDependencies: `"typescript"` → `"catalog:"`, `"unbuild"` → `"catalog:"`, `"vitest"` → `"catalog:"`, `"viem"` → `"catalog:"`
- Add: `"@chillwhales/config": "workspace:*"` to devDependencies

**packages/lsp23/package.json**:
- dependencies: `"@erc725/erc725.js"` → `"catalog:"`, `"@lukso/universalprofile-contracts": "^0.15.5"` → `"catalog:"`, `"zod"` → `"catalog:"`
- peerDependencies: `"viem"` → `"catalog:"`
- devDependencies: `"typescript"` → `"catalog:"`, `"unbuild"` → `"catalog:"`, `"vitest"` → `"catalog:"`, `"viem"` → `"catalog:"`
- Add: `"@chillwhales/config": "workspace:*"` to devDependencies

**packages/lsp29/package.json**:
- dependencies: `"zod"` → `"catalog:"`
- peerDependencies: `"viem"` → `"catalog:"`
- devDependencies: `"typescript"` → `"catalog:"`, `"unbuild"` → `"catalog:"`, `"viem"` → `"catalog:"`, `"vitest"` → `"catalog:"`
- Add: `"@chillwhales/config": "workspace:*"` to devDependencies

**packages/lsp30/package.json**:
- dependencies: `"zod"` → `"catalog:"`
- peerDependencies: `"viem"` → `"catalog:"`
- devDependencies: `"typescript"` → `"catalog:"`, `"unbuild"` → `"catalog:"`, `"viem"` → `"catalog:"`, `"vitest"` → `"catalog:"`
- Add: `"@chillwhales/config": "workspace:*"` to devDependencies

**IMPORTANT:** Workspace protocol dependencies (`"@chillwhales/lsp2": "workspace:*"`, `"@chillwhales/utils": "workspace:*"`) are NOT cataloged — they always point to the local workspace version.

**Step 3: Run `pnpm install`** to regenerate the lockfile with catalog resolutions. This MUST succeed with zero errors. If there are resolution issues, fix the catalog versions to match what was previously declared.
  </action>
  <verify>
1. `grep -c "catalog:" pnpm-workspace.yaml` — should show the catalog section exists
2. For each package, verify `grep "catalog:" packages/*/package.json` shows catalog references
3. `grep "@chillwhales/config" packages/*/package.json` — all 8 packages should reference it
4. `pnpm install` exits with code 0 (lockfile regenerated successfully)
5. No hardcoded version strings remain for deps that are in the catalog (spot-check: `grep '"zod":' packages/*/package.json` should show only `"catalog:"`, never a version string)
  </verify>
  <done>
pnpm-workspace.yaml has a catalog section with all shared dependency versions. All 8 package.json files use `"catalog:"` for cataloged deps and have `@chillwhales/config` as a devDependency. `pnpm install` succeeds.
  </done>
</task>

</tasks>

<verification>
1. `ls packages/config/package.json packages/config/src/build.ts packages/config/src/vitest.ts packages/config/tsconfig.base.json` — all 4 config files exist
2. `grep '"private": true' packages/config/package.json` — config package is private
3. `grep 'createBuildConfig' packages/config/src/build.ts` — factory exported
4. `grep 'createVitestConfig' packages/config/src/vitest.ts` — factory exported
5. `grep 'catalog:' pnpm-workspace.yaml` — catalogs section present
6. `pnpm install` — succeeds with zero errors
7. No duplicate version strings remain for cataloged deps across package.json files
</verification>

<success_criteria>
1. packages/config exists as a valid pnpm workspace package (private: true, exports ./build and ./vitest)
2. createBuildConfig and createVitestConfig factory functions are implemented with correct defaults
3. tsconfig.base.json exists at config package root with identical settings to current root config
4. pnpm-workspace.yaml has a single default catalog with all shared dependency versions
5. All 8 packages' package.json files use catalog: for every dep that appears in the catalog
6. All 8 packages list @chillwhales/config as a devDependency
7. pnpm install succeeds — lockfile is valid
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-hardening-shared-configs/01-01-SUMMARY.md`
</output>
