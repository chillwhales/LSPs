---
phase: 01-build-hardening-shared-configs
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/utils/vitest.config.ts
  - packages/lsp2/vitest.config.ts
  - packages/lsp3/vitest.config.ts
  - packages/lsp4/vitest.config.ts
  - packages/lsp6/vitest.config.ts
  - packages/lsp23/vitest.config.ts
  - packages/lsp29/vitest.config.ts
  - packages/lsp30/vitest.config.ts
  - vitest.config.ts
  - package.json
  - packages/utils/tsconfig.json
  - packages/lsp2/tsconfig.json
  - packages/lsp3/tsconfig.json
  - packages/lsp4/tsconfig.json
  - packages/lsp6/tsconfig.json
  - packages/lsp23/tsconfig.json
  - packages/lsp29/tsconfig.json
  - packages/lsp30/tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Every package's vitest.config.ts is a thin 2-liner calling createVitestConfig()"
    - "Running pnpm test from root discovers and runs all package tests via root vitest config"
    - "Every package's tsconfig.json extends @chillwhales/config/tsconfig.base.json"
    - "Per-package pnpm test still works for individual development"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Root vitest config with project discovery"
      contains: "projects"
    - path: "packages/utils/vitest.config.ts"
      provides: "Thin vitest config for utils"
      contains: "createVitestConfig"
      max_lines: 5
    - path: "packages/lsp2/vitest.config.ts"
      provides: "Thin vitest config for lsp2"
      contains: "createVitestConfig"
      max_lines: 5
    - path: "packages/utils/tsconfig.json"
      provides: "TypeScript config extending shared base"
      contains: "@chillwhales/config/tsconfig.base.json"
  key_links:
    - from: "packages/*/vitest.config.ts"
      to: "packages/config/src/vitest.ts"
      via: "import from @chillwhales/config/vitest"
      pattern: "from ['\"]@chillwhales/config/vitest['\"]"
    - from: "vitest.config.ts"
      to: "packages/*/vitest.config.ts"
      via: "test.projects glob discovery"
      pattern: "projects.*packages/\\*"
    - from: "packages/*/tsconfig.json"
      to: "packages/config/tsconfig.base.json"
      via: "extends field"
      pattern: "@chillwhales/config/tsconfig\\.base\\.json"
---

<objective>
Replace all 8 packages' vitest.config.ts with thin wrappers calling createVitestConfig(), create a root vitest.config.ts for project discovery, update root test script, and migrate all tsconfig.json files to extend from the config package.

Purpose: Satisfies BUILD-02 (shared test config) and completes the tsconfig consolidation. After this plan, all shared configs live in @chillwhales/config.
Output: 8 thin vitest.config.ts files, root vitest.config.ts, updated root test script, 8 migrated tsconfig.json files.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-hardening-shared-configs/01-CONTEXT.md
@.planning/phases/01-build-hardening-shared-configs/01-RESEARCH.md
@.planning/phases/01-build-hardening-shared-configs/01-01-SUMMARY.md
@packages/config/src/vitest.ts
@packages/config/tsconfig.base.json
@packages/utils/vitest.config.ts
@packages/utils/tsconfig.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace all vitest.config.ts with thin wrappers and create root vitest config</name>
  <files>
    packages/utils/vitest.config.ts
    packages/lsp2/vitest.config.ts
    packages/lsp3/vitest.config.ts
    packages/lsp4/vitest.config.ts
    packages/lsp6/vitest.config.ts
    packages/lsp23/vitest.config.ts
    packages/lsp29/vitest.config.ts
    packages/lsp30/vitest.config.ts
    vitest.config.ts
    package.json
  </files>
  <action>
**Step 1: Replace every package's vitest.config.ts** with the thin 2-liner:

```typescript
import { createVitestConfig } from "@chillwhales/config/vitest";

export default createVitestConfig();
```

All 8 packages get the identical file. Current configs all have `globals: true, environment: "node"` which matches the preset defaults.

**Step 2: Create root `vitest.config.ts`** at project root:

```typescript
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    projects: ["packages/*", "!packages/config"],
  },
});
```

**CRITICAL:** Use `test.projects` — NOT `vitest.workspace.ts`. Per RESEARCH.md finding: CONTEXT.md mentions `vitest.workspace.ts`, but Vitest 4.x deprecated this in favor of `test.projects` in `vitest.config.ts`. The user's intent (root-level project discovery via glob pattern) is honored using the correct Vitest 4.x API. The `!packages/config` exclusion prevents vitest from trying to discover tests in the config package (which has none).

**Step 3: Update root `package.json` test script:**

Change `"test": "pnpm -r test"` to `"test": "vitest run"`.

The root vitest.config.ts with `test.projects` handles running all package tests. Using `vitest run` directly is cleaner than `pnpm -r test` because:
- Single vitest process discovers all projects
- Unified output and exit code
- Faster (no pnpm recursive overhead)

Keep the per-package `"test": "vitest run"` scripts intact — developers can still `cd packages/lsp4 && pnpm test` per user's locked decision.
  </action>
  <verify>
1. `wc -l packages/*/vitest.config.ts` — each file should be ~3 lines
2. `grep "createVitestConfig" packages/*/vitest.config.ts` — all 8 should match
3. `cat vitest.config.ts` — root config exists with test.projects
4. `grep "vitest run" package.json` — root test script updated
5. `grep "vitest.workspace" .` — no vitest.workspace.ts file exists anywhere (deprecated API not used)
6. `pnpm test` from root — vitest discovers and runs all package tests
7. `cd packages/utils && pnpm test` — per-package test still works
  </verify>
  <done>
All 8 vitest.config.ts files are thin 2-liners. Root vitest.config.ts exists with test.projects discovery (Vitest 4.x API). Root pnpm test runs all package tests via vitest. Per-package pnpm test still works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all tsconfig.json to extend from config package</name>
  <files>
    packages/utils/tsconfig.json
    packages/lsp2/tsconfig.json
    packages/lsp3/tsconfig.json
    packages/lsp4/tsconfig.json
    packages/lsp6/tsconfig.json
    packages/lsp23/tsconfig.json
    packages/lsp29/tsconfig.json
    packages/lsp30/tsconfig.json
  </files>
  <action>
Update the `"extends"` field in each package's `tsconfig.json` from:
```json
"extends": "../../tsconfig.base.json"
```
to:
```json
"extends": "@chillwhales/config/tsconfig.base.json"
```

All other fields in each tsconfig.json remain unchanged. For reference, the current structure of each package's tsconfig.json is:
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.test.ts"]
}
```

Only the `extends` field changes. The `compilerOptions`, `include`, and `exclude` are per-package overrides that stay.

**Note on resolution:** tsconfig `extends` with a bare package specifier (e.g., `@chillwhales/config/tsconfig.base.json`) resolves by finding the package via Node module resolution, then looking for `tsconfig.base.json` at the package root. Since `packages/config/tsconfig.base.json` exists at the package root, this works correctly.

**Note on root tsconfig.base.json:** Leave the root `tsconfig.base.json` in place. It's now technically redundant (the canonical source is in the config package), but removing it could break IDE resolution or other tools. It can be cleaned up in a later phase if desired.
  </action>
  <verify>
1. `grep "extends" packages/*/tsconfig.json` — all 8 should show `@chillwhales/config/tsconfig.base.json`
2. `grep "../../tsconfig.base.json" packages/*/tsconfig.json` — should return NO results (old relative path is gone)
3. TypeScript compilation still works: `pnpm exec tsc --noEmit -p packages/utils/tsconfig.json` (spot-check one package)
4. Build still passes: `pnpm build` (since unbuild uses tsconfig for declaration generation)
  </verify>
  <done>
All 8 packages' tsconfig.json extend from @chillwhales/config/tsconfig.base.json instead of the relative ../../tsconfig.base.json path. TypeScript compilation and builds still work correctly. The config package is now the single source of truth for base TypeScript configuration.
  </done>
</task>

</tasks>

<verification>
1. All 8 vitest.config.ts are thin wrappers — `grep -c "createVitestConfig" packages/*/vitest.config.ts`
2. Root vitest.config.ts uses Vitest 4.x `test.projects` API — `grep "projects" vitest.config.ts`
3. No deprecated vitest.workspace.ts — `ls vitest.workspace.ts 2>/dev/null` returns nothing
4. Root `pnpm test` runs all package tests
5. Per-package `pnpm test` still works individually
6. All tsconfig.json extend from config package — `grep "@chillwhales/config" packages/*/tsconfig.json`
7. No relative tsconfig extends remain — `grep "../../tsconfig" packages/*/tsconfig.json` returns nothing
8. `pnpm build` still passes (tsconfig change doesn't break builds)
</verification>

<success_criteria>
1. All 8 vitest.config.ts files are thin 2-liner re-exports (no duplicated test settings)
2. Root vitest.config.ts with test.projects auto-discovers all package tests (BUILD-02 satisfied)
3. `pnpm test` from root runs all tests via single vitest instance
4. Per-package `pnpm test` works for individual development
5. All 8 tsconfig.json files extend @chillwhales/config/tsconfig.base.json
6. Builds still pass after tsconfig migration
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-hardening-shared-configs/01-03-SUMMARY.md`
</output>
