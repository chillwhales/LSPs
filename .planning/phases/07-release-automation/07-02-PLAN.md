---
phase: 07-release-automation
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - .github/workflows/preview.yml
autonomous: true
requirements: [REL-06]

must_haves:
  truths:
    - "Pushing to a PR targeting main triggers the preview workflow"
    - "Preview workflow builds and publishes only changed packages via pkg-pr-new"
    - "A PR comment with installable URLs is posted (or updated) for each push"
    - "Fork PRs do NOT trigger the preview workflow (security gate)"
    - "All existing tooling still passes after adding the preview workflow"
  artifacts:
    - path: ".github/workflows/preview.yml"
      provides: "PR-based snapshot releases via pkg-pr-new"
      contains: "pkg-pr-new"
  key_links:
    - from: ".github/workflows/preview.yml"
      to: "pkg-pr-new GitHub App"
      via: "pnpx pkg-pr-new publish posts PR comments"
      pattern: "pkg-pr-new publish"
    - from: ".github/workflows/preview.yml"
      to: "fork guard conditional"
      via: "if condition blocks fork PRs from triggering snapshots"
      pattern: "head.repo.full_name == github.repository"
---

<objective>
Create the GitHub Actions workflow for PR-based snapshot releases using pkg-pr-new, and validate the complete release automation infrastructure.

Purpose: Give PR reviewers installable preview URLs for changed packages â€” test before merge without waiting for npm publish.
Output: .github/workflows/preview.yml, validation that all release tooling works
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-release-automation/07-CONTEXT.md
@.planning/phases/07-release-automation/07-RESEARCH.md
@.planning/phases/07-release-automation/07-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 â€” executor needs to know these exist -->

From .changeset/config.json (created by Plan 01):
```json
{
  "access": "public",
  "changelog": ["@changesets/changelog-github", { "repo": "chillwhales/LSPs" }],
  "baseBranch": "main",
  "privatePackages": { "version": false, "tag": false }
}
```

From package.json (scripts added by Plan 01):
```json
{
  "scripts": {
    "changeset": "changeset",
    "ci:publish": "changeset publish"
  }
}
```

From .github/workflows/release.yml (created by Plan 01):
- Trigger: push to main
- Uses changesets/action@v1 for version PRs + publish

From .github/workflows/ci.yml (existing â€” preview.yml is a SEPARATE workflow):
- Trigger: push to main + pull_request to main
- 4-layer pipeline with build artifact passing

Packages to include in preview (only those changed vs main, exclude config which is private):
- Detected dynamically via `pnpm --filter="...[origin/main]" --filter="!@chillwhales/config"`
- Produces a subset of: utils, lsp2, lsp3, lsp4, lsp6, lsp23, lsp29, lsp30
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preview workflow for PR snapshot releases</name>
  <files>.github/workflows/preview.yml</files>
  <action>
Create `.github/workflows/preview.yml` with the following exact structure. This workflow publishes snapshot releases of **only changed packages** via pkg-pr-new on every PR push, so reviewers can install and test before merge.

```yaml
name: Preview Release

on:
  pull_request:
    branches:
      - main

jobs:
  preview:
    # Security: only run on internal branches, not forks
    # Forks could run malicious code â€” no npm tokens are used here but
    # pkg-pr-new posts comments via GitHub App which requires trust
    if: github.event.pull_request.head.repo.full_name == github.repository
    name: Publish Preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for pnpm --filter "...[origin/main]"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build changed packages
        run: pnpm --filter="...[origin/main]" --filter="!@chillwhales/config" build

      - name: Detect changed packages
        id: changed
        run: |
          CHANGED=$(pnpm --filter="...[origin/main]" --filter="!@chillwhales/config" exec -- node -e "process.stdout.write(process.cwd())" | tr '\n' ' ' | xargs -n1 realpath --relative-to=. | sed "s|^|'./|;s|$|'|" | tr '\n' ' ')
          echo "packages=$CHANGED" >> "$GITHUB_OUTPUT"
          if [ -z "$CHANGED" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish preview packages
        if: steps.changed.outputs.skip != 'true'
        run: pnpx pkg-pr-new publish ${{ steps.changed.outputs.packages }} --compact --comment=update --packageManager=pnpm
```

Key design decisions (per user decisions in CONTEXT.md):
- `on: pull_request` â€” triggers on every PR push (automatic, no opt-in needed per user decision)
- Fork guard: `if: github.event.pull_request.head.repo.full_name == github.repository` â€” blocks fork PRs from getting snapshots (security: per user decision, internal branches only)
- `fetch-depth: 0` â€” full git history required for `pnpm --filter="...[origin/main]"` to detect changed packages
- `pnpm --filter="...[origin/main]" --filter="!@chillwhales/config"` â€” only builds and snapshots packages that changed since main, excluding the private config package. This satisfies the user decision: "Only changed packages get snapshot builds"
- `--compact` â€” generates short URLs like `https://pkg.pr.new/@chillwhales/utils@abc1234` (requires `repository` field in package.json â€” already present from Phase 6)
- `--comment=update` â€” posts one PR comment and updates it on subsequent pushes (not a new comment per push, per user decision)
- `--packageManager=pnpm` â€” shows `pnpm add` in install URLs instead of `npm i`
- No NPM_TOKEN needed â€” pkg-pr-new uses its own CDN, not npm registry
- No `permissions` block needed â€” inherits default read permissions (pkg-pr-new GitHub App handles comment posting)
- No concurrency group needed â€” stale previews are harmless and each run is independent
- Skip step if no packages changed â€” avoids pkg-pr-new error on empty input

Note: The "Detect changed packages" step resolves workspace package paths into relative directory paths that pkg-pr-new expects. The executor may need to adjust the shell pipeline depending on exact pnpm output format â€” the key requirement is that only changed package directories are passed to `pkg-pr-new publish`.

The resulting PR comment will look like (showing only changed packages):
```
ðŸ“¦ Preview packages are ready!
pnpm add https://pkg.pr.new/@chillwhales/lsp2@abc1234
...
```
  </action>
  <verify>
    <automated>cat .github/workflows/preview.yml | grep -q "pkg-pr-new" && cat .github/workflows/preview.yml | grep -q "head.repo.full_name" && cat .github/workflows/preview.yml | grep -q "pull_request"</automated>
  </verify>
  <done>
    - .github/workflows/preview.yml exists with correct structure
    - Triggers on pull_request to main (every push, automatic)
    - Fork guard blocks external PRs from triggering snapshots
    - Uses pkg-pr-new with --compact, --comment=update, --packageManager=pnpm
    - No npm secrets needed (pkg-pr-new uses its own CDN)
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate complete release automation infrastructure</name>
  <files></files>
  <action>
Run a comprehensive validation of the entire Phase 7 release infrastructure. This catches integration issues between changesets config, release workflow, preview workflow, and existing tooling.

1. **Changeset status check:**
   ```
   pnpm changeset status
   ```
   Expected: exits 0, reports "No changesets present" (correct â€” no changesets added yet).

2. **Changesets config validation:**
   Verify .changeset/config.json contains all critical fields:
   - `access: "public"` (REL-03)
   - `fixed: []` and `linked: []` (REL-01 independent versioning)
   - `changelog` references `@changesets/changelog-github` (REL-02)
   - `baseBranch: "main"`
   - `privatePackages.version: false` (skip @chillwhales/config)

3. **Release workflow validation:**
   Verify .github/workflows/release.yml:
   - Triggers only on `push` to `main` (not pull_request)
   - Uses `changesets/action@v1`
   - Has `cancel-in-progress: false`
   - Has `GITHUB_TOKEN` and `NPM_TOKEN` in env
   - Has `contents: write` and `pull-requests: write` permissions
   - Has `registry-url: "https://registry.npmjs.org"` on setup-node

4. **Preview workflow validation:**
   Verify .github/workflows/preview.yml:
   - Triggers on `pull_request` to `main`
   - Has fork guard `if` condition
   - Uses `pkg-pr-new publish` with `--compact --comment=update --packageManager=pnpm`

5. **Existing tooling regression check:**
   ```
   pnpm check
   ```
   This runs biome check â†’ sherif â†’ knip â†’ madge. All must exit 0.

6. **Build check:**
   ```
   pnpm build
   ```
   Must exit 0 â€” new configs should not affect build.

7. **Test check:**
   ```
   pnpm test
   ```
   Must exit 0 â€” new configs should not affect tests.

8. **Package version verification:**
   Verify all 8 publishable packages are still at version 0.1.0:
   ```
   pnpm -r --filter './packages/*' --filter '!@chillwhales/config' exec -- node -e "console.log(require('./package.json').name + '@' + require('./package.json').version)"
   ```
   All should report `@chillwhales/<pkg>@0.1.0`.

If any check fails, investigate and fix the root cause before marking complete. Common issues:
- knip reports changesets deps as unused â†’ add to ignoreDependencies in knip.json
- sherif complains about new deps â†’ check version consistency
  </action>
  <verify>
    <automated>pnpm changeset status && pnpm check && pnpm build && pnpm test</automated>
  </verify>
  <done>
    - pnpm changeset status exits 0
    - .changeset/config.json has all required fields (access, changelog, independent versioning, privatePackages)
    - release.yml has correct triggers, permissions, changesets/action config, concurrency settings
    - preview.yml has correct triggers, fork guard, pkg-pr-new config
    - pnpm check exits 0 (biome + sherif + knip + madge all pass)
    - pnpm build exits 0 (no build regressions)
    - pnpm test exits 0 (no test regressions)
    - All 8 packages at version 0.1.0
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/preview.yml` exists with pkg-pr-new, fork guard, and correct triggers
2. All three workflow files coexist: ci.yml (unchanged), release.yml (Plan 01), preview.yml (this plan)
3. `pnpm changeset status` exits 0
4. `pnpm check` exits 0 (all linting/hygiene tools pass)
5. `pnpm build` exits 0
6. `pnpm test` exits 0
7. All 8 packages at version 0.1.0
</verification>

<success_criteria>
- PR-based snapshot releases are configured via pkg-pr-new with fork security
- The complete release automation stack is validated end-to-end:
  - Changesets for versioning (REL-01, REL-02, REL-03)
  - Release workflow for version PRs + publish (REL-04, REL-05, REL-07)
  - Preview workflow for snapshots (REL-06)
- All existing tooling continues to work (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/07-release-automation/07-02-SUMMARY.md`
</output>
