---
phase: 07-release-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .changeset/config.json
  - .changeset/README.md
  - package.json
  - pnpm-lock.yaml
  - knip.json
  - .github/workflows/release.yml
autonomous: true
requirements: [REL-01, REL-02, REL-03, REL-04, REL-05, REL-07]

must_haves:
  truths:
    - "Running `pnpm changeset` launches the interactive changeset creator"
    - "Running `pnpm changeset status` reports package status without error"
    - ".changeset/config.json specifies independent versioning (no fixed or linked groups)"
    - ".changeset/config.json sets access to public for scoped packages"
    - "release.yml uses changesets/action to create version PRs on push to main"
    - "release.yml uses changesets/action to publish to npm when no changesets pending"
    - "release.yml creates GitHub Releases by default (createGithubReleases: true)"
  artifacts:
    - path: ".changeset/config.json"
      provides: "Changesets configuration for independent versioning with public access"
      contains: "access.*public"
    - path: ".changeset/README.md"
      provides: "Developer guidance for adding changesets"
    - path: ".github/workflows/release.yml"
      provides: "Version PR creation + npm publish + GitHub Releases workflow"
      contains: "changesets/action"
    - path: "package.json"
      provides: "changeset and ci:publish scripts"
      contains: "ci:publish"
  key_links:
    - from: ".github/workflows/release.yml"
      to: ".changeset/config.json"
      via: "changesets/action reads config for versioning behavior"
      pattern: "changesets/action"
    - from: ".github/workflows/release.yml"
      to: "npm registry"
      via: "NPM_TOKEN secret → changeset publish → pnpm publish"
      pattern: "NPM_TOKEN"
    - from: ".changeset/config.json"
      to: "@changesets/changelog-github"
      via: "changelog preset configuration"
      pattern: "changelog-github"
---

<objective>
Install and configure @changesets/cli for independent package versioning, and create the GitHub Actions release workflow that automatically creates version PRs and publishes to npm.

Purpose: Automate the entire release pipeline — from changeset collection to npm publish — so merging to main is the only manual step.
Output: .changeset/config.json, .github/workflows/release.yml, root package.json scripts
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-release-automation/07-CONTEXT.md
@.planning/phases/07-release-automation/07-RESEARCH.md

<interfaces>
<!-- Existing codebase contracts the executor needs -->

From package.json (root):
```json
{
  "name": "@chillwhales/lsps",
  "private": true,
  "scripts": {
    "build": "pnpm -r build",
    "test": "vitest run",
    "check": "pnpm check:lint && pnpm sherif && pnpm knip && pnpm madge",
    "prepare": "simple-git-hooks"
  },
  "devDependencies": {
    "@biomejs/biome": "^2.4.4",
    "@commitlint/cli": "^20.4.2",
    "knip": "^5.85.0",
    "vitest": "catalog:"
  },
  "packageManager": "pnpm@10.30.2"
}
```

From knip.json:
```json
{
  "workspaces": {
    ".": {
      "entry": [],
      "project": [],
      "ignoreBinaries": ["tsc"]
    },
    "packages/*": {
      "entry": ["src/**/*.test.ts"],
      "project": ["src/**/*.ts"]
    }
  }
}
```

From pnpm-workspace.yaml:
```yaml
packages:
  - packages/*
catalog:
  typescript: ^5.9.3
  unbuild: ^3.6.1
  vitest: ^4.0.17
  zod: ^3.24.1
  viem: ^2.0.0
```

From .github/workflows/ci.yml (existing CI — release.yml is a SEPARATE workflow):
- Triggers: push to main + pull_request to main
- 4-layer pipeline: install → validate+build → verify+test → coverage
- concurrency: cancel-in-progress: true
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @changesets/cli and configure for independent versioning</name>
  <files>.changeset/config.json, .changeset/README.md, package.json, pnpm-lock.yaml, knip.json</files>
  <action>
1. Install changesets dependencies as root devDependencies:
   ```
   pnpm add -Dw @changesets/cli @changesets/changelog-github
   ```

2. Initialize the .changeset directory:
   ```
   pnpm changeset init
   ```
   This creates `.changeset/config.json` and `.changeset/README.md`.

3. Replace the generated `.changeset/config.json` with this exact content:
   ```json
   {
     "$schema": "https://unpkg.com/@changesets/config@3/schema.json",
     "changelog": [
       "@changesets/changelog-github",
       { "repo": "chillwhales/LSPs" }
     ],
     "commit": false,
     "fixed": [],
     "linked": [],
     "access": "public",
     "baseBranch": "main",
     "updateInternalDependencies": "patch",
     "ignore": [],
     "privatePackages": {
       "version": false,
       "tag": false
     }
   }
   ```

   Key config rationale (per user decisions in CONTEXT.md):
   - `access: "public"` — REL-03: scoped @chillwhales/* packages publish publicly (npm defaults scoped to restricted)
   - `fixed: [], linked: []` — REL-01: independent versioning, packages diverge naturally
   - `changelog: ["@changesets/changelog-github", ...]` — REL-02: PR attribution with author credit
   - `updateInternalDependencies: "patch"` — when lsp2 bumps, lsp3/lsp4/lsp23/lsp29 get their workspace dep range updated
   - `privatePackages: { version: false, tag: false }` — skip @chillwhales/config (private devDependency package)
   - `commit: false` — the changesets/action handles commits in the version PR
   - `baseBranch: "main"` — matches existing CI trigger

4. Add scripts to root `package.json`. Add these two entries to the existing `scripts` object:
   ```json
   "changeset": "changeset",
   "ci:publish": "changeset publish"
   ```
   - `changeset` — convenience alias for `pnpm changeset` (interactive changeset creator)
   - `ci:publish` — used by the release workflow; `changeset publish` creates git tags + publishes via pnpm

5. Check if knip reports @changesets/cli or @changesets/changelog-github as unused:
   ```
   pnpm knip
   ```
   If knip reports them as unused dependencies, add them to the root workspace's `ignoreDependencies` in `knip.json`:
   ```json
   {
     ".": {
       "ignoreDependencies": ["@changesets/changelog-github"]
     }
   }
   ```
   Note: knip has a built-in changesets plugin that may detect @changesets/cli automatically via the `.changeset/config.json` file. Only add ignoreDependencies entries for deps that knip actually flags — do not preemptively ignore.

6. Verify `pnpm changeset status` runs without error (will report "No changesets present" which is expected).
  </action>
  <verify>
    <automated>pnpm changeset status && pnpm knip && cat .changeset/config.json | grep -q '"access": "public"'</automated>
  </verify>
  <done>
    - .changeset/config.json exists with independent versioning, public access, @changesets/changelog-github, privatePackages config
    - .changeset/README.md exists with developer guidance
    - Root package.json has "changeset" and "ci:publish" scripts
    - pnpm changeset status exits 0
    - pnpm knip exits 0 (no false positives from new deps)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions release workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create `.github/workflows/release.yml` with the following exact structure. This workflow has two modes:
- **Changesets pending** (after feature PRs merge): creates/updates a "chore: version packages" PR with bumped versions and changelog entries
- **No changesets pending** (after version PR merges): publishes changed packages to npm and creates GitHub Releases

```yaml
name: Release

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # CRITICAL: never cancel in-progress releases — partial publish is dangerous

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Push version PR commits + create GitHub Releases
      pull-requests: write   # Create/update version PR
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Create Release PR or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          commit: "chore: version packages"
          title: "chore: version packages"
          publish: pnpm ci:publish
          version: pnpm changeset version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
```

Key design decisions (DO NOT deviate):
- `cancel-in-progress: false` — per user decision, on partial publish failure just retry. Cancelling mid-publish is dangerous.
- `commit: "chore: version packages"` — conforms to conventional commit format enforced by commitlint
- `title: "chore: version packages"` — version PR title
- `publish: pnpm ci:publish` — runs `changeset publish` which creates git tags AND publishes. NOT `pnpm publish -r` because changeset publish creates tags the action needs for GitHub Releases.
- `version: pnpm changeset version` — bumps versions + generates changelogs
- `GITHUB_TOKEN` — provided by GitHub automatically, needed for version PR creation and @changesets/changelog-github to fetch PR info
- `NPM_TOKEN` — repository secret the user must add (documented in user_setup). Needed for npm publish.
- `registry-url` on setup-node — ensures npm commands use the correct registry
- `createGithubReleases` defaults to `true` in changesets/action — REL-07 covered without explicit config
- Build step runs before changesets/action — the publish command needs dist/ artifacts

Do NOT add `id-token: write` permission — npm provenance is optional and adds complexity. Keep it simple for initial release.
  </action>
  <verify>
    <automated>cat .github/workflows/release.yml | grep -q "changesets/action" && cat .github/workflows/release.yml | grep -q "cancel-in-progress: false" && cat .github/workflows/release.yml | grep -q "NPM_TOKEN"</automated>
  </verify>
  <done>
    - .github/workflows/release.yml exists with correct structure
    - Uses changesets/action@v1 with commit, title, publish, version inputs
    - Triggers only on push to main (not PRs)
    - cancel-in-progress: false (never cancel in-progress releases)
    - GITHUB_TOKEN and NPM_TOKEN configured in env
    - GitHub Releases created by default (createGithubReleases: true is the default)
  </done>
</task>

</tasks>

<verification>
1. `pnpm changeset status` exits 0 (reports "No changesets present")
2. `.changeset/config.json` has `access: "public"`, `fixed: []`, `linked: []`, `@changesets/changelog-github`
3. `.github/workflows/release.yml` has `changesets/action@v1` with correct inputs and permissions
4. `pnpm knip` exits 0 (no unused dependency false positives)
5. `pnpm check` exits 0 (biome + sherif + knip + madge all pass)
6. `pnpm build` exits 0 (build unaffected by new config)
7. `pnpm test` exits 0 (tests unaffected by new config)
</verification>

<success_criteria>
- Changesets is fully configured for independent versioning of 8 public packages
- @changesets/changelog-github preset will generate PR-attributed changelogs
- Release workflow will create version PRs and publish to npm when the version PR merges
- GitHub Releases will be auto-created for each published package
- All existing tooling (knip, biome, sherif, madge, build, test) continues to pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-release-automation/07-01-SUMMARY.md`
</output>
