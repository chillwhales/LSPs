---
phase: 02-code-quality-biome-git-hooks
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - package.json
  - commitlint.config.mjs
autonomous: true

must_haves:
  truths:
    - "Committing unformatted code is blocked by the pre-commit hook"
    - "Committing with a non-conventional message is rejected by the commit-msg hook"
    - "Hooks are auto-installed on pnpm install via prepare script"
  artifacts:
    - path: "commitlint.config.mjs"
      provides: "Commitlint configuration with conventional preset"
      contains: "@commitlint/config-conventional"
    - path: "package.json"
      provides: "simple-git-hooks configuration and prepare script"
      contains: "simple-git-hooks"
  key_links:
    - from: "package.json#simple-git-hooks.pre-commit"
      to: "@biomejs/biome"
      via: "biome check --write --staged"
      pattern: "biome check.*--staged"
    - from: "package.json#simple-git-hooks.commit-msg"
      to: "commitlint"
      via: "commitlint --edit"
      pattern: "commitlint --edit"
    - from: "package.json#scripts.prepare"
      to: "simple-git-hooks"
      via: "prepare lifecycle script"
      pattern: "simple-git-hooks"
---

<objective>
Configure git hooks to automatically enforce Biome formatting on commit and conventional commit message format, ensuring code quality standards are maintained going forward.

Purpose: Establishes automatic enforcement (QUAL-03, QUAL-07) so code quality is maintained without manual discipline. Pre-commit auto-fixes formatting; commit-msg validates conventional format.

Output: Configured simple-git-hooks with pre-commit (Biome) and commit-msg (commitlint) hooks
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-code-quality-biome-git-hooks/02-RESEARCH.md
@.planning/phases/02-code-quality-biome-git-hooks/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure simple-git-hooks and commitlint</name>
  <files>package.json, commitlint.config.mjs</files>
  <action>
1. Install dev dependencies at root workspace level:
   ```
   pnpm add -D -w simple-git-hooks @commitlint/cli @commitlint/config-conventional
   ```

2. Add simple-git-hooks configuration to root `package.json`:
   ```json
   "simple-git-hooks": {
     "pre-commit": "npx @biomejs/biome check --write --staged --files-ignore-unknown=true --no-errors-on-unmatched && git update-index --again",
     "commit-msg": "npx commitlint --edit $1"
   }
   ```
   
   **Pre-commit hook behavior:**
   - `--write` auto-fixes formatting and safe lint issues on staged files
   - `--staged` operates only on files in the git staging area (requires vcs.enabled in biome.json)
   - `--files-ignore-unknown=true` skips files Biome can't handle (YAML, images, etc.)
   - `--no-errors-on-unmatched` prevents errors when no matching files are staged
   - `git update-index --again` re-stages files that Biome auto-formatted
   - If lint errors remain after safe fixes, Biome exits non-zero and blocks the commit
   
   **Commit-msg hook behavior:**
   - `commitlint --edit $1` reads the commit message file and validates conventional format
   - Rejects messages not matching: `type(optional-scope): description`

3. Add `prepare` script to root `package.json` scripts:
   ```json
   "prepare": "simple-git-hooks"
   ```
   This auto-installs hooks when anyone runs `pnpm install` (including fresh clones).
   Merge with existing scripts — do NOT remove existing scripts (check, check:fix, build, test, etc.).

4. Create `commitlint.config.mjs` at repo root:
   ```javascript
   export default { extends: ["@commitlint/config-conventional"] };
   ```
   Using `.mjs` extension because the project's root package.json does not have `"type": "module"` — plain `.js` would default to CJS and fail with ESM export syntax.
   
   The @commitlint/config-conventional preset provides all 11 standard types: feat, fix, docs, style, refactor, test, chore, ci, perf, build, revert. Scopes are optional with no allowed-list enforcement per user decision.

5. Install the hooks by running:
   ```
   npx simple-git-hooks
   ```
   This writes the hook commands into `.git/hooks/pre-commit` and `.git/hooks/commit-msg`.
  </action>
  <verify>
  - `cat .git/hooks/pre-commit` contains `biome check --write --staged`
  - `cat .git/hooks/commit-msg` contains `commitlint --edit`
  - `cat commitlint.config.mjs` contains `@commitlint/config-conventional`
  - `grep '"prepare"' package.json` shows `simple-git-hooks`
  - `test -x .git/hooks/pre-commit && echo "executable"` confirms pre-commit is executable
  - `test -x .git/hooks/commit-msg && echo "executable"` confirms commit-msg is executable
  </verify>
  <done>simple-git-hooks is configured with pre-commit (Biome staged check + auto-format) and commit-msg (commitlint conventional format) hooks. Hooks are installed in .git/hooks/ and are executable. prepare script ensures hooks auto-install on pnpm install.</done>
</task>

<task type="auto">
  <name>Task 2: Verify hook enforcement end-to-end</name>
  <files></files>
  <action>
1. **Test commitlint directly** (fast, no git required):
   ```
   echo "bad message" | npx commitlint
   ```
   Must exit non-zero (rejected).
   
   ```
   echo "feat: add feature" | npx commitlint
   ```
   Must exit zero (accepted).
   
   ```
   echo "fix(scope): something" | npx commitlint
   ```
   Must exit zero (scoped message accepted).

2. **Test commit-msg hook rejects bad messages:**
   Stage a trivial change (e.g., add blank line to a file), then attempt:
   ```
   git commit -m "fixed stuff"
   ```
   Must be rejected by commitlint. Unstage the change after (no commit was made).

3. **Test pre-commit hook auto-fixes formatting:**
   Create a temporary test file with intentionally poor formatting (wrong indentation, single quotes, missing trailing commas). Stage it and attempt a commit with a valid conventional message:
   ```
   git commit -m "test: verify pre-commit hook auto-formats staged files"
   ```
   The pre-commit hook should auto-fix formatting and allow the commit.
   Verify the committed file has correct formatting (tabs, double quotes, trailing commas).
   Then revert the test commit and remove the test file:
   ```
   git reset --soft HEAD~1
   git reset HEAD <test-file>
   rm <test-file>
   ```

4. **Test pre-commit hook blocks lint errors:**
   Create a file with an intentional lint violation that Biome's recommended rules catch and cannot auto-fix. Stage it and attempt a commit:
   ```
   git commit -m "test: this should be blocked"
   ```
   Must be rejected (non-zero exit from Biome). Clean up the test file.

5. **Clean up:** Ensure no test artifacts remain. Run `git status` to confirm a clean working tree.

If any test fails, debug the hook configuration:
- Hook not executable: `chmod +x .git/hooks/pre-commit .git/hooks/commit-msg`
- npx not found in hook context: ensure pnpm/node is in PATH
- commitlint config not found: verify commitlint.config.mjs exists at repo root
  </action>
  <verify>
  - `echo "bad message" | npx commitlint` exits non-zero
  - `echo "feat: add feature" | npx commitlint` exits zero
  - Attempting `git commit -m "fixed stuff"` is rejected by commit-msg hook
  - Pre-commit hook auto-formats staged files (verified via test commit)
  - `git status` shows clean working tree after all tests
  </verify>
  <done>Both git hooks work correctly end-to-end: pre-commit auto-fixes formatting and blocks unfixable lint errors, commit-msg enforces conventional commit format. All test artifacts cleaned up.</done>
</task>

</tasks>

<verification>
- `echo "bad message" | npx commitlint` exits non-zero — commitlint rejects bad messages
- `echo "feat: valid" | npx commitlint` exits zero — commitlint accepts conventional format
- `.git/hooks/pre-commit` exists, is executable, contains `biome check --write --staged`
- `.git/hooks/commit-msg` exists, is executable, contains `commitlint --edit`
- `grep '"prepare": "simple-git-hooks"' package.json` — auto-install on pnpm install
</verification>

<success_criteria>
1. Committing unformatted code triggers auto-fix by the pre-commit hook
2. Committing code with unfixable lint errors is blocked by the pre-commit hook
3. Committing with "fixed stuff" is rejected by the commit-msg hook
4. Committing with "feat: add feature" is accepted by the commit-msg hook
5. Running `pnpm install` auto-installs hooks via the prepare script
</success_criteria>

<output>
After completion, create `.planning/phases/02-code-quality-biome-git-hooks/02-02-SUMMARY.md`
</output>
