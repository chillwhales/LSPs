---
phase: 02-code-quality-biome-git-hooks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - biome.json
  - .editorconfig
  - package.json
  - .git-blame-ignore-revs
autonomous: true

must_haves:
  truths:
    - "Running pnpm biome check from root succeeds with zero errors on all packages"
    - "A single biome.json at root governs all packages — no per-package biome configs"
    - "All files use consistent formatting: tabs, 80-char width, double quotes, trailing commas"
  artifacts:
    - path: "biome.json"
      provides: "Root Biome configuration for entire monorepo"
      contains: "recommended"
    - path: ".editorconfig"
      provides: "Editor settings matching Biome tab indentation"
      contains: "indent_style = tab"
    - path: ".git-blame-ignore-revs"
      provides: "Git blame ignore for initial formatting commit"
  key_links:
    - from: "biome.json"
      to: ".gitignore"
      via: "vcs.useIgnoreFile: true"
      pattern: "useIgnoreFile.*true"
    - from: "package.json#scripts.check"
      to: "@biomejs/biome"
      via: "biome check script"
      pattern: "biome check"
---

<objective>
Install and configure Biome as the single linting and formatting tool for the entire monorepo, then apply formatting to all existing code.

Purpose: Establishes consistent code quality standards (QUAL-01, QUAL-02) that all future development must follow. The initial format pass creates a clean baseline before git hooks enforce it.

Output: biome.json config, updated .editorconfig, formatted codebase, .git-blame-ignore-revs
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-code-quality-biome-git-hooks/02-RESEARCH.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Biome and create root configuration</name>
  <files>biome.json, .editorconfig, package.json</files>
  <action>
1. Install Biome as a root workspace dev dependency:
   ```
   pnpm add -D -w @biomejs/biome
   ```

2. Create `biome.json` at the repo root with this minimal configuration:
   ```json
   {
     "$schema": "https://biomejs.dev/schemas/2.4.4/schema.json",
     "vcs": {
       "enabled": true,
       "clientKind": "git",
       "useIgnoreFile": true
     },
     "files": {
       "includes": ["**", "!!**/dist"]
     },
     "formatter": {
       "enabled": true
     },
     "linter": {
       "enabled": true,
       "rules": {
         "recommended": true
       }
     }
   }
   ```
   
   **IMPORTANT:** Do NOT add explicit formatter settings for indentation, line width, quotes, or trailing commas. All four locked formatting preferences (tabs, 80-char width, double quotes, trailing commas `all`) are Biome v2 defaults. Leaving them out keeps the config minimal per user decision.

3. Update `.editorconfig` to match Biome's tab-based formatting:
   - Change `indent_style = space` to `indent_style = tab`
   - Remove `indent_size = 2` (not applicable with tabs)
   - Keep all other settings: `end_of_line = lf`, `charset = utf-8`, `trim_trailing_whitespace = true`, `insert_final_newline = true`

4. Add Biome scripts to root `package.json` scripts:
   - `"check": "biome check"`
   - `"check:fix": "biome check --write"`
   Merge with existing scripts — do NOT remove existing scripts like `build`, `test`, etc.
  </action>
  <verify>
  - `pnpm biome --version` outputs Biome version (confirms installation)
  - `cat biome.json` shows minimal config with recommended rules and no explicit formatter overrides
  - `grep "indent_style = tab" .editorconfig` confirms tab indentation
  - `grep '"check"' package.json` confirms check script exists
  </verify>
  <done>Biome is installed and configured. biome.json uses recommended rules with all formatting defaults. .editorconfig matches Biome's tab indentation. check/check:fix scripts are available in root package.json.</done>
</task>

<task type="auto">
  <name>Task 2: Format and lint entire codebase</name>
  <files>packages/**/*.ts, packages/**/*.json, biome.json, .git-blame-ignore-revs</files>
  <action>
1. Run Biome in dry-run mode first to inventory all violations:
   ```
   pnpm biome check . 2>&1 | tail -20
   ```
   Note the count and types of violations before fixing.

2. Run Biome with auto-fix to format and apply safe lint fixes:
   ```
   pnpm biome check --write .
   ```
   This applies: formatting (2-space→tabs, quote normalization, trailing commas), import sorting, and safe lint auto-fixes. It does NOT apply unsafe fixes (no `--unsafe` flag).

3. Check for remaining lint errors:
   ```
   pnpm biome check .
   ```
   If any remain:
   - If a recommended rule genuinely conflicts with established codebase patterns (e.g., Zod's `z.infer` usage, viem type patterns, bare `catch` blocks), add a targeted rule override in biome.json under `linter.rules`. Use the most specific override possible (rule-level, not group-level).
   - If fixable manually, fix the code.
   - Iterate `check --write` and `check` until zero errors remain.
   - Goal: zero errors, zero warnings. All lint violations are errors per user decision — no ambiguity.

4. Verify builds still pass after formatting:
   ```
   pnpm build
   ```
   Formatting changes (indentation, quotes) should not affect build output, but verify.

5. Verify tests still pass:
   ```
   pnpm test
   ```
   Note: 10 pre-existing test failures in @chillwhales/lsp29 are known (Zod schema: images field required but missing in fixtures). These are NOT caused by formatting changes. Confirm no NEW failures.

6. Create `.git-blame-ignore-revs` at repo root. After the formatting changes are committed (use message like `style(02-01): apply biome formatting to entire codebase`), capture the commit hash and add it to `.git-blame-ignore-revs`:
   ```
   # Biome initial formatting — spaces to tabs, import sorting, quote normalization
   <commit-hash>
   ```
   Then configure git to use it:
   ```
   git config blame.ignoreRevsFile .git-blame-ignore-revs
   ```
  </action>
  <verify>
  - `pnpm biome check .` exits with code 0 (zero errors)
  - `pnpm build` succeeds with zero warnings
  - `pnpm test` — no new test failures compared to pre-format baseline
  - `.git-blame-ignore-revs` exists at repo root with the formatting commit hash
  </verify>
  <done>Every file in the monorepo is consistently formatted by Biome with zero errors. Builds and tests are unaffected by formatting changes. .git-blame-ignore-revs is configured so git blame skips the formatting commit.</done>
</task>

</tasks>

<verification>
- `pnpm biome check .` exits 0 — all files pass lint and format checks
- `pnpm build` succeeds — formatting didn't break builds
- `pnpm test` — no new test failures from formatting changes
- `ls packages/*/biome.json 2>/dev/null` returns nothing — no per-package configs exist
- `grep "indent_style = tab" .editorconfig` — editor config aligned with Biome
- `cat .git-blame-ignore-revs` — contains formatting commit hash
</verification>

<success_criteria>
1. A single biome.json at repo root configures linting and formatting for all 8 packages
2. Running `pnpm biome check` from root exits 0 with zero errors
3. All .ts and .json files use tabs, 80-char width, double quotes, and trailing commas
4. Builds pass (`pnpm build` exits 0)
5. No new test failures introduced by formatting changes
6. .git-blame-ignore-revs tracks the formatting commit
</success_criteria>

<output>
After completion, create `.planning/phases/02-code-quality-biome-git-hooks/02-01-SUMMARY.md`
</output>
