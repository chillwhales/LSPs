---
phase: 08-external-code-extraction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/lsp2/src/image-utils.ts
  - packages/lsp2/src/image-utils.test.ts
  - packages/lsp4/src/asset-utils.ts
  - packages/lsp4/src/asset-utils.test.ts
  - packages/lsp4/src/types.ts
  - packages/lsp6/src/key-builders.ts
  - packages/lsp6/src/erc725y.ts
  - packages/lsp6/src/index.ts
  - packages/lsp6/src/erc725y.test.ts
  - packages/lsp6/package.json
autonomous: true
requirements: [EXT-01]

must_haves:
  truths:
    - "@chillwhales/lsp2 includes additional image selection functions (findSmallestImage, findBiggestImage, findOptimalImage, etc.)"
    - "@chillwhales/lsp4 includes getAssetImageUrl, getNftImageUrl, and getNftDisplayName functions"
    - "@chillwhales/lsp6 includes LSP17 extension key builders and getData utility"
    - "LSP-specific constants from marketplace merged into their respective packages"
    - "All modified packages build with zero warnings"
    - "All new functions have test coverage"
  artifacts:
    - path: "packages/lsp2/src/image-utils.ts"
      provides: "Extended image utilities with findSmallestImage, findBiggestImage, findOptimalImage, findClosestImageByArea, findClosestImageByAspectRatio, getPreviewImageUrl"
    - path: "packages/lsp4/src/asset-utils.ts"
      provides: "Extended asset utilities with getAssetImageUrl, getNftImageUrl, getNftDisplayName"
    - path: "packages/lsp6/src/erc725y.ts"
      provides: "ERC725Y read utilities and LSP17 extension key builders"
  key_links:
    - from: "packages/lsp4/src/asset-utils.ts"
      to: "@chillwhales/lsp2"
      via: "findBestImage import"
      pattern: "import.*findBestImage.*from.*@chillwhales/lsp2"
    - from: "packages/lsp6/src/index.ts"
      to: "packages/lsp6/src/erc725y.ts"
      via: "barrel export"
      pattern: "export \\* from.*erc725y"
---

<objective>
Extract LSP-specific utility functions and constants from chillwhales/marketplace into their respective existing @chillwhales/* packages.

Purpose: Marketplace contains LSP3, LSP4, and ERC725Y utilities that are currently duplicated or missing from the monorepo. Extracting genuinely new functions enriches the published packages. Duplicate functions are skipped (monorepo version wins per user decision).

Output: @chillwhales/lsp2, lsp4, and lsp6 packages enriched with new functions from marketplace, fully tested.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-external-code-extraction/08-CONTEXT.md

Source repo: https://github.com/chillwhales/marketplace (private — gh CLI has access)
Source files: packages/utils/src/lsp3.ts, lsp4.ts, lsp2.ts, lsp23.ts, lsp26.ts, lsp29.ts, erc725y.ts, images.ts, digital-asset.ts
Source constants: packages/constants/src/lsp2.ts, lsp4.ts, lsp29.ts
</context>

<interfaces>
<!-- Existing @chillwhales/lsp2 image-utils.ts exports -->
From packages/lsp2/src/image-utils.ts:
```typescript
export interface ImageSize { width: number; height: number; }
export function findBestImage(images: Image[] | undefined, options?: Partial<ImageSize>): Image | undefined;
export function findClosestImage(images: Image[], targetWidth: number, targetHeight: number): Image | null;
```

<!-- Existing @chillwhales/lsp4 asset-utils.ts exports -->
From packages/lsp4/src/asset-utils.ts:
```typescript
export function getImageUrl(options: { image?: Image | null; icon?: Image | null; preferIcon?: boolean; parseUrl: (url: string) => string; }): string | undefined;
export function getAssetDisplayName(metadata: LSP4Metadata): string;
```

<!-- Existing @chillwhales/lsp6 exports -->
From packages/lsp6/src/key-builders.ts:
```typescript
export function buildPermissionsKey(address: Address): Hex;
export function buildAllowedCallsKey(address: Address): Hex;
export function buildAllowedErc725DataKeysKey(address: Address): Hex;
```

From packages/lsp6/src/parsers.ts:
```typescript
export function parseCompactBytesArray(data: Hex, address: Address): Hex[];
export function parseAllowedCalls(data: Hex, address: Address): AllowedCall[];
export function allowedCallMatches(actual: AllowedCall, required: AllowedCall): boolean;
```

<!-- Existing Image type from @chillwhales/lsp2 -->
From packages/lsp2/src/types.ts:
```typescript
export type Image = z.infer<typeof imageSchema>;
// { url: string; width: number; height: number; hash?: string; hashFunction?: string; }
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Extract new LSP-specific functions from marketplace into existing packages</name>
  <files>
    packages/lsp2/src/image-utils.ts
    packages/lsp4/src/asset-utils.ts
    packages/lsp4/src/types.ts
    packages/lsp6/src/erc725y.ts
    packages/lsp6/src/index.ts
    packages/lsp6/package.json
  </files>
  <action>
**Step 1: Clone marketplace repo (if not already present from Plan 01)**
```bash
[ -d /tmp/marketplace ] || git clone --depth 1 https://github.com/chillwhales/marketplace.git /tmp/marketplace
```

**Step 2: Extract new image utilities → @chillwhales/lsp2**

Read marketplace `packages/utils/src/images.ts`. The following functions ALREADY EXIST in @chillwhales/lsp2 (SKIP):
- `findBestImage` — DUPLICATE
- `findClosestImage` — DUPLICATE

Extract these NEW functions into `packages/lsp2/src/image-utils.ts` (append to existing file):
- `findSmallestImage(images: Image[]): Image | null` — finds smallest by area
- `findBiggestImage(images: Image[]): Image | null` — finds biggest by area
- `findOptimalImage(images: Image[], targetWidth: number, targetHeight: number): Image | null` — smallest image >= target size, fallback to biggest
- `findClosestImageByArea(images: Image[], targetWidth: number, targetHeight: number): Image | null` — uses area difference metric
- `findClosestImageByAspectRatio(images: Image[], targetWidth: number, targetHeight: number): Image | null` — weighted aspect ratio + area
- `getPreviewImageUrl(images: Image[][] | undefined, parseUrl: (url: string) => string): string | null` — first image from nested array

Adapt types:
- Replace `ImagesArray` (from `@chillpass/zod`) with `Image[]` (from `./types`)
- Replace `ImagesMatrix` with `Image[][]`
- Use the existing `Image` type already in `packages/lsp2/src/types.ts`

**Step 3: Extract new LSP4 functions → @chillwhales/lsp4**

Read marketplace `packages/utils/src/lsp4.ts`. Functions ALREADY in @chillwhales/lsp4 (SKIP):
- `getImageUrl` — DUPLICATE (identical implementation)
- `getAssetDisplayName` — DUPLICATE

Extract these NEW functions into `packages/lsp4/src/asset-utils.ts` (append):
- `getAssetImageUrl(metadata: LSP4Metadata, parseUrl: (url: string) => string, options?: Partial<ImageSize>): string | undefined` — prefers icon, falls back to images array
- `getNftImageUrl(metadata: LSP4Metadata, parseUrl: (url: string) => string, options?: Partial<ImageSize>): string | undefined` — prefers images, falls back to icon (reverse of asset)
- `getNftDisplayName(metadata: LSP4Metadata & { tokenName?: string; tokenIdFormat?: string; formattedTokenId?: string }): string` — formats name with token ID

Adapt types:
- Replace marketplace `DigitalAsset` / `NFT` types from `@chillpass/zod` with `LSP4Metadata` from `./types`
- The marketplace `DigitalAsset` has fields: `icon`, `images`, `name`, `tokenName`. LSP4Metadata may not have all. Check and extend `LSP4Metadata` type in `packages/lsp4/src/types.ts` if needed (add optional `tokenName`, `tokenIdFormat`, `formattedTokenId` fields).
- Import `findBestImage`, `ImageSize` from `@chillwhales/lsp2` (already used by existing asset-utils)

**Step 4: Extract new ERC725Y/LSP17 functions → @chillwhales/lsp6**

Read marketplace `packages/utils/src/erc725y.ts`. Functions ALREADY in @chillwhales/lsp6 (SKIP):
- `buildPermissionsKey` — DUPLICATE
- `buildAllowedCallsKey` — DUPLICATE
- `buildAllowedDataKeysKey` — DUPLICATE
- `parseCompactBytesArray` — DUPLICATE
- `parseAllowedCalls` — DUPLICATE
- `allowedCallMatches` — DUPLICATE (marketplace version has different return type with detailed excessive flags — note this enhancement but keep monorepo version per user decision)

Create NEW file `packages/lsp6/src/erc725y.ts` with:
- `buildLsp17ExtensionKey(selector: Hex): Hex` — builds LSP17 extension data key from function selector
- `extractSelectorFromLsp17ExtensionKey(key: Hex): Hex` — extracts selector from LSP17 key
- `extractLsp17ExtensionKeys(dataKeys: Hex[]): Hex[]` — filters array to only LSP17 keys
- `getData(client: PublicClient, contractAddress: Address, dataKey: Hex): Promise<Hex>` — reads single ERC725Y data key
- `getData(client: PublicClient, contractAddress: Address, dataKeys: Hex[]): Promise<Hex[]>` — reads multiple ERC725Y data keys (overloaded)
- `isHexEqual(a: Hex, b: Hex): boolean` — case-insensitive hex comparison

Dependencies: The `getData` function uses `universalProfileAbi` from `@lukso/universalprofile-contracts/abi`. This import is already available in the monorepo. Add `@lukso/lsp17contractextension-contracts` to lsp6 package.json dependencies for LSP17DataKeys constant. Check if available in catalog or pin version.

Update `packages/lsp6/src/index.ts` to add: `export * from "./erc725y";`

**Step 5: Evaluate remaining marketplace LSP files**

Read and evaluate each remaining LSP file. For each one:

- `lsp2.ts` — check for functions NOT in @chillwhales/lsp2. If genuinely new, add to lsp2 package. If duplicates, skip.
- `lsp3.ts` — ALREADY confirmed: `getProfileImageUrl` and `getProfileDisplayName` are DUPLICATES. Skip entire file.
- `lsp23.ts` — check for functions NOT in @chillwhales/lsp23. Skip duplicates.
- `lsp29.ts` — check for functions NOT in @chillwhales/lsp29. Skip duplicates.
- `lsp26.ts` — LSP26 (Follower System). No @chillwhales/lsp26 exists. Per CONTEXT.md only lsp1 and erc725 are new packages. If functions are simple (1-2 functions), add to @chillwhales/utils. If substantial, note in SUMMARY as candidate for future @chillwhales/lsp26 package.
- `digital-asset.ts` — evaluate if functions overlap with @chillwhales/lsp4 or are app-specific. Extract general ones.
- `abi.ts` (from utils, not constants) — evaluate if general ABI helpers or marketplace-specific

**Step 6: Extract LSP-specific constants**

From marketplace `packages/constants/src/`:
- `lsp2.ts` → check for constants NOT in @chillwhales/lsp2 constants.ts. Add new ones.
- `lsp4.ts` → check for constants NOT in @chillwhales/lsp4 constants.ts. Add new ones.
- `lsp29.ts` → check for constants NOT in @chillwhales/lsp29 constants.ts. Add new ones.
- Use `UPPER_SNAKE_CASE` for constants, `as const` for literal types (per monorepo convention)

**Step 7: Format and lint**
- All new code: tab indentation, double quotes, trailing commas (Biome defaults)
- JSDoc on all exported functions with @param, @returns, @throws, @example
- Section separators between existing and new code: `// ============================================================================`
  </action>
  <verify>
    <automated>pnpm --filter @chillwhales/lsp2 build && pnpm --filter @chillwhales/lsp4 build && pnpm --filter @chillwhales/lsp6 build 2>&1 | tail -5</automated>
  </verify>
  <done>
    All genuinely new LSP-specific functions from marketplace extracted into respective packages. Duplicate functions skipped (monorepo version wins). All modified packages build with zero warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for all extracted LSP-specific functions</name>
  <files>
    packages/lsp2/src/image-utils.test.ts
    packages/lsp4/src/asset-utils.test.ts
    packages/lsp6/src/erc725y.test.ts
  </files>
  <action>
**Step 1: Port and extend lsp2 image-utils tests**

Read existing `packages/lsp2/src/image-utils.test.ts` (if exists). Add new test cases for:
- `findSmallestImage` — empty array returns null, single image returns it, multiple returns smallest by area
- `findBiggestImage` — same pattern, returns biggest by area
- `findOptimalImage` — returns smallest image >= target, falls back to biggest when none large enough
- `findClosestImageByArea` — returns image with closest area to target
- `findClosestImageByAspectRatio` — returns image with best combined aspect ratio + area match
- `getPreviewImageUrl` — returns first image URL parsed, returns null for empty/undefined

Port relevant tests from marketplace `packages/utils/src/images.test.ts` (if it exists — some marketplace files don't have tests).

**Step 2: Write lsp4 asset-utils tests**

Read existing `packages/lsp4/src/asset-utils.test.ts` (if exists). Add new tests for:
- `getAssetImageUrl` — with icon only, with images only, with both (prefers icon), with target dimensions, with no images
- `getNftImageUrl` — with images only, with icon only, with both (prefers images), with no images
- `getNftDisplayName` — with tokenName + NUMBER format + formattedTokenId, with tokenName only, with no name

Use mock LSP4Metadata objects with Image arrays. Use a simple `parseUrl` mock: `(url: string) => url.replace('ipfs://', 'https://gateway/')`.

**Step 3: Write lsp6 erc725y tests**

Create `packages/lsp6/src/erc725y.test.ts`:
- `buildLsp17ExtensionKey` — produces correct 32-byte key with LSP17 prefix + selector + zero padding
- `extractSelectorFromLsp17ExtensionKey` — extracts correct 4-byte selector from key
- `extractLsp17ExtensionKeys` — filters array to only LSP17-prefixed keys
- `isHexEqual` — case-insensitive comparison (0xABC == 0xabc), different values return false
- `getData` — use mocked PublicClient (vi.fn() or test double). Verify it calls readContract with correct args for single and batch reads. Test error wrapping.

**Step 4: Run all tests**
```bash
pnpm --filter @chillwhales/lsp2 test
pnpm --filter @chillwhales/lsp4 test
pnpm --filter @chillwhales/lsp6 test
```
Fix any failures.

**Step 5: Lint check**
```bash
pnpm check:lint
```
Fix any Biome issues in test files.

**Step 6: Clean up**
```bash
rm -rf /tmp/marketplace
```
  </action>
  <verify>
    <automated>pnpm --filter @chillwhales/lsp2 test && pnpm --filter @chillwhales/lsp4 test && pnpm --filter @chillwhales/lsp6 test 2>&1 | tail -10</automated>
  </verify>
  <done>
    All new LSP-specific functions have tests. Tests pass across lsp2, lsp4, and lsp6 packages. All modified packages build with zero warnings. Marketplace clone removed.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @chillwhales/lsp2 build && pnpm --filter @chillwhales/lsp2 test` exits 0
2. `pnpm --filter @chillwhales/lsp4 build && pnpm --filter @chillwhales/lsp4 test` exits 0
3. `pnpm --filter @chillwhales/lsp6 build && pnpm --filter @chillwhales/lsp6 test` exits 0
4. `pnpm check:lint` passes on all modified files
5. No `@chillpass/zod` imports remain in any monorepo file
6. Only genuinely NEW functions added — no duplicates of existing monorepo functions
</verification>

<success_criteria>
- @chillwhales/lsp2 has >=5 new image utility functions
- @chillwhales/lsp4 has getAssetImageUrl, getNftImageUrl, getNftDisplayName
- @chillwhales/lsp6 has LSP17 key builders and getData utility
- All new functions documented with JSDoc and tested
- All modified packages build with zero warnings
</success_criteria>

<output>
After completion, create `.planning/phases/08-external-code-extraction/08-02-SUMMARY.md`
</output>
