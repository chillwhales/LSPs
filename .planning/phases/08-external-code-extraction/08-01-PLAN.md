---
phase: 08-external-code-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/utils/src/address.ts
  - packages/utils/src/blockchain.ts
  - packages/utils/src/currency.ts
  - packages/utils/src/time.ts
  - packages/utils/src/ipfs.ts
  - packages/utils/src/files.ts
  - packages/utils/src/urls.ts
  - packages/utils/src/images.ts
  - packages/utils/src/collections.ts
  - packages/utils/src/links.ts
  - packages/utils/src/mime-types.ts
  - packages/utils/src/pagination.ts
  - packages/utils/src/transformers.ts
  - packages/utils/src/validation.ts
  - packages/utils/src/constants.ts
  - packages/utils/src/index.ts
  - packages/utils/package.json
autonomous: true
requirements: [EXT-01]

must_haves:
  truths:
    - "@chillwhales/utils exports general utility functions extracted from chillwhales/marketplace"
    - "Address utilities (normalize, truncate, compare, format) work with viem Address type"
    - "IPFS utilities (CID extraction, gateway URL building) work with ipfs:// URLs"
    - "Blockchain helpers (uint128 encode/decode) work with viem Hex type"
    - "All new utility functions have passing tests"
    - "@chillwhales/utils builds with zero warnings"
  artifacts:
    - path: "packages/utils/src/address.ts"
      provides: "Address formatting, comparison, and validation functions"
    - path: "packages/utils/src/blockchain.ts"
      provides: "ERC725Y uint128 encode/decode helpers"
    - path: "packages/utils/src/ipfs.ts"
      provides: "IPFS URL parsing and CID extraction"
    - path: "packages/utils/src/index.ts"
      provides: "Updated barrel exports including all new modules"
    - path: "packages/utils/package.json"
      provides: "Updated dependencies (viem peer dep)"
  key_links:
    - from: "packages/utils/src/index.ts"
      to: "new utility modules"
      via: "export * from ./module"
      pattern: "export \\* from"
    - from: "packages/utils/package.json"
      to: "viem"
      via: "peerDependencies"
      pattern: "peerDependencies.*viem"
---

<objective>
Extract general-purpose utility functions from the chillwhales/marketplace monorepo into @chillwhales/utils.

Purpose: Marketplace contains ~15 utility modules (address, blockchain, currency, time, ipfs, etc.) that are general-purpose and reusable. Extracting them eliminates duplication and makes them available as published npm packages.

Output: @chillwhales/utils package expanded with all general utility functions, formatted to monorepo conventions, fully tested.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-external-code-extraction/08-CONTEXT.md

Source repo: https://github.com/chillwhales/marketplace (private — gh CLI has access)
Source directory: packages/utils/src/ and packages/constants/src/
</context>

<interfaces>
<!-- Existing @chillwhales/utils exports (executor must preserve these) -->

From packages/utils/src/index.ts:
```typescript
export * from "./numbers";
export * from "./strings";
```

From packages/utils/src/strings.ts:
```typescript
export function isEqual(a: string, b: string): boolean;
```

From packages/utils/src/numbers.ts:
```typescript
export function isNumeric(value: unknown): value is number | string;
```

<!-- Current utils package.json — NO runtime deps, NO peer deps -->
<!-- After extraction: viem added as peerDependency for address/blockchain modules -->
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Clone marketplace and extract general utility functions into @chillwhales/utils</name>
  <files>
    packages/utils/src/address.ts
    packages/utils/src/blockchain.ts
    packages/utils/src/currency.ts
    packages/utils/src/time.ts
    packages/utils/src/ipfs.ts
    packages/utils/src/files.ts
    packages/utils/src/urls.ts
    packages/utils/src/images.ts
    packages/utils/src/collections.ts
    packages/utils/src/links.ts
    packages/utils/src/mime-types.ts
    packages/utils/src/pagination.ts
    packages/utils/src/transformers.ts
    packages/utils/src/validation.ts
    packages/utils/src/constants.ts
    packages/utils/src/index.ts
    packages/utils/package.json
  </files>
  <action>
**Step 1: Clone marketplace repo**
```bash
git clone --depth 1 https://github.com/chillwhales/marketplace.git /tmp/marketplace
```

**Step 2: Audit marketplace/packages/utils/src/ and packages/constants/src/**

Read each file. For every function, classify as:
- **EXTRACT to utils** — General-purpose (no LSP-specific types, no app-specific logic)
- **SKIP** — Already exists in monorepo (check @chillwhales/utils, @chillwhales/lsp2)
- **DEFER to Plan 02** — LSP-specific (lsp2.ts, lsp3.ts, lsp4.ts, lsp23.ts, lsp26.ts, lsp29.ts, erc725y.ts, digital-asset.ts)
- **SKIP permanently** — App-specific (transaction-errors.ts, standards.ts if marketplace-specific)

**Files to EXTRACT (general utilities):**
- `address.ts` → `packages/utils/src/address.ts` (all functions: normalizeAddress, safeNormalizeAddress, isValidAddress, truncateAddress, formatAddress, formatAddressWithLabel, compareAddresses, isAddressInList, findAddress, uniqueAddresses, sortAddresses). Uses viem — add viem as peerDependency.
- `blockchain.ts` → `packages/utils/src/blockchain.ts` (parseUint128, encodeUint128). Uses viem.
- `currency.ts` → `packages/utils/src/currency.ts` — read and extract
- `time.ts` → `packages/utils/src/time.ts` — read and extract
- `ipfs.ts` → `packages/utils/src/ipfs.ts` (extractCidFromIpfsUrl, parseIpfsUrl, isIpfsUrl, cidToIpfsUrl, cidToGatewayUrl). **SKIP `computeCidFromString`** — it requires `ipfs-only-hash` which adds significant weight. Note it in JSDoc as "available in marketplace, omitted to keep utils lightweight."
- `files.ts` → `packages/utils/src/files.ts` — read and extract general file helpers
- `urls.ts` → `packages/utils/src/urls.ts` — read and extract URL helpers
- `images.ts` → **SKIP most** (findBestImage, findClosestImage already exist in @chillwhales/lsp2). However, `findSmallestImage`, `findBiggestImage`, `findOptimalImage`, `findClosestImageByArea`, `findClosestImageByAspectRatio` are NEW. Extract these to `packages/utils/src/images.ts`. **SKIP `getImageSize`** — uses browser `Image` constructor, not suitable for Node-only library. Replace `ImagesArray` / `ImagesMatrix` types from `@chillpass/zod` with inline type `Array<{ width: number; height: number; url: string }>` or import `Image` type from `@chillwhales/lsp2`.
- `collections.ts` → `packages/utils/src/collections.ts` — read and extract if general-purpose
- `links.ts` → `packages/utils/src/links.ts` — read and extract
- `mime-types.ts` → `packages/utils/src/mime-types.ts` — read and extract
- `pagination.ts` → `packages/utils/src/pagination.ts` — read and extract
- `transformers.ts` → `packages/utils/src/transformers.ts` — read and extract general transformers
- `validation.ts` → `packages/utils/src/validation.ts` — read and extract general validators
- `crypto/` directory → read and evaluate. If general crypto helpers, extract. If app-specific encryption, skip.

**Files to extract from marketplace/packages/constants/src/ (general constants only):**
- `addresses.ts`, `known-addresses.ts` → `packages/utils/src/constants.ts` (LUKSO known addresses — contract addresses, etc.)
- `config.ts`, `general.ts`, `content.ts`, `uploads.ts`, `crypto.ts` → merge into `packages/utils/src/constants.ts` if general-purpose; skip if marketplace-specific
- **SKIP** `lsp2.ts`, `lsp4.ts`, `lsp29.ts` (LSP-specific → Plan 02)
- **SKIP** `abi.ts` if marketplace-specific ABIs

**Step 3: For each extracted file:**
1. Replace `@chillpass/zod` imports with appropriate types (inline or from `@chillwhales/lsp2`)
2. Replace relative imports from marketplace (`./images`, `./address`) with local imports
3. Format with tab indentation, double quotes (Biome defaults)
4. Add JSDoc module header following monorepo convention (see @chillwhales/lsp2 for pattern)
5. Add JSDoc on each exported function with `@param`, `@returns`, `@throws`, `@example`
6. Use `as const` for constant arrays/objects
7. Export as individual named exports (tree-shakeable)

**Step 4: Merge with existing utils**
- `numbers.ts` — marketplace may have overlapping number utilities. Check marketplace `numbers.ts` for NEW functions not in monorepo. Add only genuinely new ones.
- `strings.ts` — same: check for new functions, add only new ones. Preserve existing `isEqual`.

**Step 5: Update package.json**
- Add `viem` as peerDependency: `"viem": "catalog:"` (consistent with PKG-04 pattern)
- Add `viem` to devDependencies: `"viem": "catalog:"` (for testing)
- Add `zod` as dependency ONLY if any extracted util uses Zod (unlikely for general utils)
- Do NOT add `ipfs-only-hash` (we're skipping computeCidFromString)

**Step 6: Update barrel**
- Update `packages/utils/src/index.ts` to export all new modules via `export * from "./module"`
- Preserve existing exports for numbers and strings

**Decision rules per CONTEXT.md:**
- On naming conflicts: monorepo version wins (keep existing functions, only add new)
- Flat named exports — no subpath exports
- Constants as individual named exports (tree-shakeable, auto-completable)
- Keep external deps, declare properly (viem as peer)
  </action>
  <verify>
    <automated>pnpm --filter @chillwhales/utils build 2>&1 | tail -5</automated>
  </verify>
  <done>
    All general utility functions from marketplace extracted into @chillwhales/utils. Package builds with zero warnings. No marketplace-specific or LSP-specific code included. Index.ts exports all new modules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for all extracted utilities and verify package</name>
  <files>
    packages/utils/src/address.test.ts
    packages/utils/src/blockchain.test.ts
    packages/utils/src/currency.test.ts
    packages/utils/src/time.test.ts
    packages/utils/src/ipfs.test.ts
    packages/utils/src/images.test.ts
  </files>
  <action>
**Step 1: Port existing tests from marketplace**
- Read marketplace test files (address.test.ts, blockchain.test.ts, currency.test.ts, time.test.ts, files.test.ts, numbers.test.ts, validation.test.ts, transformers.test.ts)
- Port relevant test cases that cover extracted functions
- Adapt imports from marketplace paths to @chillwhales/utils imports
- Format tests to use Vitest globals (no import needed for describe, it, expect)
- Use tab indentation, double quotes (Biome defaults)

**Step 2: Write new tests for functions without marketplace tests**
For any extracted function that lacks marketplace tests, write tests covering:
- Happy path with valid inputs
- Edge cases (empty arrays, null values, undefined)
- Error cases (invalid inputs that should throw)

**Step 3: Specific test requirements**
- `address.test.ts` — test normalizeAddress (valid/invalid), truncateAddress (various lengths), compareAddresses (case sensitivity, null handling), uniqueAddresses (dedup)
- `blockchain.test.ts` — test parseUint128 (zero, normal, large values), encodeUint128 (number, bigint, string inputs)
- `ipfs.test.ts` — test extractCidFromIpfsUrl (ipfs:// protocol, gateway URLs, data URIs), parseIpfsUrl (with string/function gateways), isIpfsUrl
- `images.test.ts` — test findSmallestImage, findBiggestImage, findOptimalImage with mock image arrays

**Step 4: Run tests and fix**
```bash
pnpm --filter @chillwhales/utils test
```
Fix any failures. Ensure all tests pass.

**Step 5: Run full quality checks on utils package**
```bash
pnpm --filter @chillwhales/utils build
pnpm check:lint
```
Fix any Biome lint/format issues in new files.

**Step 6: Clean up temporary clone**
```bash
rm -rf /tmp/marketplace
```
  </action>
  <verify>
    <automated>pnpm --filter @chillwhales/utils test 2>&1 && pnpm --filter @chillwhales/utils build 2>&1 | tail -3</automated>
  </verify>
  <done>
    All extracted utility functions have tests. Tests pass. Package builds. Biome lint passes on all new files. Marketplace temp clone removed.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @chillwhales/utils build` exits 0 with zero warnings
2. `pnpm --filter @chillwhales/utils test` exits 0, all tests pass
3. `pnpm check:lint` passes (no Biome errors in new files)
4. `packages/utils/src/index.ts` exports all new modules
5. `packages/utils/package.json` has viem in peerDependencies
6. No `@chillpass/zod` imports remain in any file
7. No marketplace-specific or LSP-specific code in utils package
</verification>

<success_criteria>
- @chillwhales/utils contains >=10 new utility modules extracted from marketplace
- All functions are pure, documented with JSDoc, and tested
- Package builds with zero warnings
- viem correctly declared as peer dependency
- Existing utils functions (isEqual, isNumeric) preserved
</success_criteria>

<output>
After completion, create `.planning/phases/08-external-code-extraction/08-01-SUMMARY.md`
</output>
