---
phase: 03-dependency-monorepo-hygiene
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - knip.json
  - scripts/check-circular.mjs
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "knip, sherif, madge, and only-allow are installed as root devDependencies"
    - "pnpm knip runs knip against the workspace"
    - "pnpm sherif runs sherif with fail-on-warnings"
    - "pnpm madge detects inter-package circular dependencies only (ignores intra-package cycles)"
    - "pnpm deps:graph generates a visual dependency graph SVG"
    - "pnpm check runs all hygiene tools sequentially (biome → sherif → knip → madge)"
    - "pnpm check:lint runs biome check (renamed from pnpm check)"
    - "Running npm install or yarn install in the repo root fails with a clear pnpm enforcement error"
  artifacts:
    - path: "knip.json"
      provides: "Workspace-aware knip configuration for 9 packages"
      contains: "workspaces"
    - path: "scripts/check-circular.mjs"
      provides: "Inter-package circular dependency filtering script"
      contains: "inter-package"
    - path: "package.json"
      provides: "Restructured scripts with all hygiene tools + preinstall + sherif config"
      contains: "preinstall"
  key_links:
    - from: "knip.json"
      to: "pnpm-workspace.yaml"
      via: "knip workspace auto-detection"
      pattern: "packages/\\*"
    - from: "scripts/check-circular.mjs"
      to: "madge"
      via: "spawnSync call with --circular --json flags"
      pattern: "madge.*--circular.*--json"
    - from: "package.json"
      to: "only-allow"
      via: "preinstall lifecycle hook"
      pattern: "npx only-allow pnpm"
---

<objective>
Install and configure all four dependency hygiene tools (knip, sherif, madge, only-allow) for the pnpm monorepo workspace.

Purpose: Establish the tool infrastructure so violations can be detected. This plan handles installation, configuration files, and script wiring — the next plan handles running tools and fixing violations.
Output: All tools installed, configured, and invocable via dedicated pnpm scripts.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dependency-monorepo-hygiene/03-RESEARCH.md
@.planning/phases/03-dependency-monorepo-hygiene/03-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and restructure root package.json</name>
  <files>package.json, pnpm-lock.yaml, .gitignore</files>
  <action>
  **Install all four tools:**
  ```bash
  pnpm add -D knip sherif madge only-allow
  ```

  If knip warns about missing `@types/node` peer dependency, add it too:
  ```bash
  pnpm add -D @types/node
  ```

  **Restructure scripts in root package.json:**

  Rename existing scripts (per user decision — `pnpm check` becomes the umbrella command):
  - `"check": "biome check"` → `"check:lint": "biome check"`
  - `"check:fix": "biome check --write"` → `"check:lint:fix": "biome check --write"`

  Add new scripts:
  - `"preinstall": "npx only-allow pnpm"` — blocks npm/yarn install (QUAL-06)
  - `"knip": "knip"` — runs knip workspace analysis
  - `"sherif": "sherif"` — runs sherif monorepo linting
  - `"madge": "node scripts/check-circular.mjs"` — runs inter-package circular dependency check
  - `"deps:graph": "madge --image deps-graph.svg --extensions ts --ts-config ./packages/utils/tsconfig.json packages/*/src"` — generates visual dependency graph
  - `"check": "pnpm check:lint && pnpm sherif && pnpm knip && pnpm madge"` — umbrella command running all hygiene tools sequentially (fastest → slowest: biome → sherif → knip → madge)

  Keep existing scripts unchanged: `build`, `test`, `clean`, `prepare`.

  **Add sherif configuration in root package.json:**
  ```json
  "sherif": {
    "failOnWarnings": true
  }
  ```
  This makes sherif strict — zero tolerance per user decision.

  **Add deps-graph.svg to .gitignore:**
  The visual dependency graph is an on-demand developer tool, not committed to the repo (per user decision). Append `deps-graph.svg` to `.gitignore`.

  **Important:** Do NOT modify `simple-git-hooks` config — the pre-commit hook uses `npx @biomejs/biome check` directly (not `pnpm check`), so the script rename doesn't affect it.
  </action>
  <verify>
  - `cat package.json | node -e "const p=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')); console.log(Object.keys(p.scripts).sort().join(', '))"` shows: build, check, check:lint, check:lint:fix, clean, deps:graph, knip, madge, preinstall, prepare, sherif, test
  - `cat package.json | node -e "const p=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')); console.log(p.sherif?.failOnWarnings)"` shows: true
  - `grep deps-graph.svg .gitignore` shows the entry
  - `pnpm ls knip sherif madge only-allow --depth=0` shows all four installed
  </verify>
  <done>All four tools installed as devDependencies. Root package.json has restructured scripts with preinstall, dedicated tool scripts, and umbrella check command. sherif configured with failOnWarnings. deps-graph.svg is gitignored.</done>
</task>

<task type="auto">
  <name>Task 2: Create knip workspace configuration and madge inter-package filtering script</name>
  <files>knip.json, scripts/check-circular.mjs</files>
  <action>
  **Create knip.json at repo root** with workspace-aware configuration:

  ```json
  {
    "$schema": "https://unpkg.com/knip@5/schema.json",
    "workspaces": {
      ".": {
        "entry": [],
        "project": [],
        "ignoreDependencies": ["simple-git-hooks"]
      },
      "packages/*": {
        "entry": [
          "src/index.ts",
          "src/**/*.test.ts"
        ],
        "project": ["src/**/*.ts"]
      },
      "packages/config": {
        "entry": [
          "src/build.ts",
          "src/vitest.ts"
        ],
        "project": ["src/**/*.ts"],
        "includeEntryExports": true
      }
    }
  }
  ```

  Key configuration rationale:
  - Root workspace (`"."`) has no entry/project (no source code at root). `ignoreDependencies: ["simple-git-hooks"]` because it's used via package.json config key, not code imports.
  - `packages/*` uses `src/index.ts` as entry (barrel export pattern) and `src/**/*.test.ts` as additional entries (test files are valid entry points per user decision). `includeEntryExports` is NOT set (defaults to false) — library barrel exports are the public API, not unused code.
  - `packages/config` overridden separately — it has no `src/index.ts` barrel, instead it exports `src/build.ts` and `src/vitest.ts` via subpath exports. `includeEntryExports: true` because config is private — unused exports should be flagged.
  - knip auto-detects vitest and unbuild plugins from devDependencies — no manual plugin config needed.

  **Create scripts/check-circular.mjs** — Node.js script that runs madge and filters to inter-package cycles only:

  The script must:
  1. Run `madge --circular --json --extensions ts --ts-config ./packages/utils/tsconfig.json packages/*/src` via `child_process.execSync` (or handle the non-zero exit when cycles found)
  2. Parse the JSON output (array of cycle arrays, where each cycle is an array of file paths)
  3. For each cycle, extract the package name from each file path (pattern: `packages/{name}/src/...`)
  4. Keep only cycles where files span MORE than one package directory (inter-package)
  5. Discard cycles where all files are within the same package (intra-package)
  6. If inter-package cycles found: print each cycle with full file paths joined by ` → `, exit 1
  7. If no inter-package cycles: print success message, exit 0

  Use `node:child_process` spawnSync (not execSync) so we can read stdout regardless of exit code. madge exits non-zero when ANY circular deps are found. Use `shell: true` for glob expansion of `packages/*/src`.

  Exclude test files from analysis: pass `--exclude "\\.test\\.ts$"` to madge.

  **Important:** The `--ts-config` flag points to `./packages/utils/tsconfig.json` — any package's tsconfig works since they all extend the same base config. madge uses it for TypeScript path resolution.

  Create the `scripts/` directory if it doesn't exist.
  </action>
  <verify>
  - `cat knip.json | node -e "const k=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')); console.log(Object.keys(k.workspaces).join(', '))"` shows: ., packages/*, packages/config
  - `test -f scripts/check-circular.mjs && echo "exists"` shows: exists
  - `pnpm knip --help 2>&1 | head -1` runs without error (knip resolves config)
  - `node scripts/check-circular.mjs 2>&1; echo "exit: $?"` runs without crashing (may find cycles — that's OK, fixing is Plan 02)
  </verify>
  <done>knip.json exists with workspace-aware configuration covering root, library packages, and config package. scripts/check-circular.mjs exists and filters madge output to inter-package cycles only. Both tools are invocable via their pnpm scripts.</done>
</task>

</tasks>

<verification>
- `pnpm knip --help` — knip is installed and finds config
- `pnpm sherif --help` — sherif is installed
- `node scripts/check-circular.mjs` — madge runs (may report issues, fixing is Plan 02)
- `cat package.json | node -e "const p=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')); console.log(p.scripts.preinstall)"` — shows `npx only-allow pnpm`
- `pnpm check:lint` — biome check runs (renamed from pnpm check)
</verification>

<success_criteria>
- All four tools (knip, sherif, madge, only-allow) installed in devDependencies
- knip.json exists with correct workspace configuration for all 9 packages
- scripts/check-circular.mjs exists and runs madge with inter-package filtering
- Root package.json scripts restructured: check is umbrella, check:lint is biome, dedicated scripts for each tool
- preinstall hook blocks non-pnpm package managers
- sherif configured with failOnWarnings: true
- deps-graph.svg is in .gitignore
</success_criteria>

<output>
After completion, create `.planning/phases/03-dependency-monorepo-hygiene/03-01-SUMMARY.md`
</output>
